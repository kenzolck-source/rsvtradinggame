<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é‡‘èä¿ å®¢ä¿®ä»™éŒ„ï¼šKç·šé£›æ˜‡ç‰ˆ</title>
    <style>
        :root {
            --bg-color: #0d1117;
            --panel-bg: #161b22;
            --border: #30363d;
            --text-main: #c9d1d9;
            --text-dim: #8b949e;
            --highlight: #f2cc60; /* é‡‘è‰² */
            --accent: #58a6ff;    /* è—è‰² */
            --red: #ff7b72;       /* è·Œ/è™§ */
            --green: #3fb950;     /* æ¼²/ç›ˆ */
            --rare: #d2a8ff;      /* ç´«è‰² */
            --legendary: #ffa657; /* æ©™è‰² */
        }

        * { box-sizing: border-box; user-select: none; }

        body {
            font-family: 'Segoe UI', 'Microsoft JhengHei', monospace;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            height: 100vh;
            overflow: hidden;
        }

        /* æƒæç·šç‰¹æ•ˆ */
        body::after {
            content: " ";
            display: block;
            position: absolute;
            top: 0; left: 0; bottom: 0; right: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.03), rgba(0, 255, 0, 0.01), rgba(0, 0, 255, 0.03));
            z-index: 999;
            background-size: 100% 2px, 3px 100%;
            pointer-events: none;
        }

        #game-container {
            width: 100%;
            max-width: 600px;
            background-color: var(--bg-color);
            display: flex;
            flex-direction: column;
            border-left: 1px solid var(--border);
            border-right: 1px solid var(--border);
            position: relative;
        }

        /* HUD å„€è¡¨æ¿ */
        #hud {
            background: var(--panel-bg);
            padding: 15px;
            border-bottom: 1px solid var(--border);
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .hud-card {
            background: rgba(255,255,255,0.03);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 10px;
            display: flex;
            flex-direction: column;
        }

        .main-stat { font-size: 20px; font-weight: bold; color: var(--highlight); letter-spacing: 1px; }
        .sub-stat { font-size: 11px; color: var(--text-dim); margin-top: 2px; }
        
        .attr-row { display: flex; justify-content: space-between; font-size: 12px; margin-top: 5px; }
        .attr-box { display: flex; align-items: center; gap: 4px; }
        
        /* é€²åº¦æ¢ */
        .bar-bg { width: 60px; height: 6px; background: #333; border-radius: 3px; overflow: hidden; }
        .bar-fill { height: 100%; transition: width 0.3s; }

        /* Kç·šåœ–å€åŸŸ */
        #chart-area {
            position: relative;
            height: 250px;
            background: #0d1117;
            border-bottom: 1px solid var(--border);
        }
        canvas { width: 100%; height: 100%; display: block; }
        
        #stock-overlay {
            position: absolute; top: 10px; left: 10px;
            pointer-events: none;
        }
        .stock-title { font-size: 22px; font-weight: 900; color: rgba(255,255,255,0.8); text-shadow: 0 2px 4px rgba(0,0,0,0.8); }
        .stock-sub { font-size: 12px; color: rgba(255,255,255,0.5); }

        #news-marquee {
            background: #1f1f1f;
            color: var(--highlight);
            padding: 8px;
            font-size: 13px;
            white-space: nowrap;
            overflow: hidden;
            border-bottom: 1px solid var(--border);
            display: flex; align-items: center;
        }
        .news-tag { background: var(--red); color: #000; font-weight: bold; font-size: 10px; padding: 1px 4px; border-radius: 2px; margin-right: 8px; }
        .news-tag.good { background: var(--green); }

        /* æ—¥èªŒå€ */
        #log-area {
            flex-grow: 1;
            overflow-y: auto;
            padding: 10px;
            font-size: 13px;
            display: flex; flex-direction: column; gap: 5px;
        }
        .log-item { padding: 6px 10px; border-left: 2px solid #333; background: rgba(255,255,255,0.02); animation: slideIn 0.2s; }
        .log-item.profit { border-left-color: var(--red); background: rgba(255, 77, 77, 0.05); }
        .log-item.loss { border-left-color: var(--green); background: rgba(46, 204, 113, 0.05); }
        @keyframes slideIn { from { opacity: 0; transform: translateX(-10px); } to { opacity: 1; transform: translateX(0); } }

        /* ç‰©å“æ¬„ */
        #inventory {
            height: 50px; background: #111; border-top: 1px solid var(--border);
            display: flex; align-items: center; padding: 0 10px; gap: 5px; overflow-x: auto;
        }
        .item { 
            min-width: 36px; height: 36px; border: 1px solid #444; border-radius: 4px; 
            display: flex; justify-content: center; align-items: center; font-size: 18px; cursor: pointer; position: relative;
        }
        .item:hover { border-color: var(--highlight); background: #222; }
        .item-badge { position: absolute; bottom: -2px; right: -2px; font-size: 9px; background: #000; color: #fff; padding: 0 2px; }

        /* æ§åˆ¶å€ */
        #controls {
            padding: 10px; background: var(--panel-bg); display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;
        }
        .control-group { grid-column: span 4; display: flex; align-items: center; justify-content: space-between; margin-bottom: 5px; }
        
        button {
            padding: 12px; border: none; border-radius: 4px; color: white; font-weight: bold; font-family: inherit; cursor: pointer; position: relative; overflow: hidden;
            transition: transform 0.1s;
        }
        button:active { transform: scale(0.98); }
        .btn-buy { background: var(--red); grid-column: span 2; } /* è¯äººå€ç´…æ¼² */
        .btn-sell { background: var(--green); grid-column: span 2; } /* è¯äººå€ç¶ è·Œ */
        .btn-skip { background: #333; grid-column: span 4; color: #aaa; padding: 8px; font-size: 12px; }

        /* æ»‘å¡Š */
        input[type=range] { width: 100px; accent-color: var(--highlight); }

        /* Modal */
        .modal {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95);
            z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px;
            backdrop-filter: blur(8px);
        }
        .hidden { display: none !important; }
        
        .card-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 100%; max-height: 70vh; overflow-y: auto; }
        .choice-card {
            background: #21262d; border: 1px solid var(--border); padding: 15px; border-radius: 6px; cursor: pointer;
        }
        .choice-card:hover { border-color: var(--highlight); background: #2c313a; }
        .choice-card.selected { border-color: var(--highlight); box-shadow: 0 0 15px rgba(242, 204, 96, 0.2); }
        .choice-card h3 { margin: 0 0 5px 0; color: var(--highlight); }
        .choice-card p { font-size: 12px; color: var(--text-dim); margin: 0; line-height: 1.4; }

        .dice-btn { background: #21262d; border: 1px solid var(--border); width: 40px; }
    </style>
</head>
<body>

<!-- Start Screen -->
<div id="start-screen" class="modal">
    <h1 style="color:var(--highlight); text-transform:uppercase; letter-spacing:3px; margin-bottom:5px;">é‡‘èä¿ å®¢</h1>
    <span style="font-size:12px; color:var(--text-dim); margin-bottom:20px;">VER 3.0 // K-LINE UPDATE</span>
    
    <div style="display:flex; gap:5px; width:100%; margin-bottom:15px;">
        <input type="text" id="input-name" placeholder="è¼¸å…¥é“è™Ÿ" style="flex:1; padding:10px; background:#0d1117; border:1px solid var(--border); color:#fff;">
        <button class="dice-btn" onclick="randomName()">ğŸ²</button>
    </div>

    <p style="font-size:12px; color:var(--text-dim)">è«‹é¸æ“‡ 2 é …é–‹å±€å¤©è³¦ï¼š</p>
    <div id="trait-list" class="card-grid"></div>
    <button onclick="startGame()" style="width:100%; margin-top:15px; background:var(--highlight); color:#000;">åˆå§‹åŒ–è³¬æˆ¶</button>
</div>

<!-- Roguelike Level Up -->
<div id="levelup-screen" class="modal hidden">
    <h2 style="color:var(--rare)">å¢ƒç•Œçªç ´</h2>
    <p style="font-size:12px; color:#aaa; margin-bottom:20px;">æœ¬æœˆçµç®—å®Œæˆï¼Œè«‹é¸æ“‡ä¸€é …èƒ½åŠ›ï¼š</p>
    <div id="skill-choices" class="card-grid" style="grid-template-columns: 1fr;"></div>
</div>

<!-- Main Game -->
<div id="game-container" class="hidden">
    <!-- HUD -->
    <div id="hud">
        <div class="hud-card">
            <span class="sub-stat">ç¸½è³‡ç”¢ (ç›®æ¨™: $1å„„)</span>
            <span class="main-stat" id="ui-money">$0</span>
            <div class="attr-row">
                <span>æœˆæ”¶æ”¯: <span id="ui-income" style="color:var(--green)">+$0</span></span>
                <span>Day <span id="ui-day">1</span></span>
            </div>
        </div>
        <div class="hud-card">
            <span class="sub-stat">ç‹€æ…‹ç›£æ§</span>
            <div class="attr-row" style="margin-top:8px;">
                <div class="attr-box">âš¡ <div class="bar-bg"><div id="bar-stress" class="bar-fill" style="width:0%; background:var(--red)"></div></div></div>
                <div class="attr-box">ğŸ˜„ <div class="bar-bg"><div id="bar-happy" class="bar-fill" style="width:100%; background:var(--highlight)"></div></div></div>
            </div>
            <div class="attr-row">
                <span>ğŸ€ é‹æ°£: <span id="ui-luck">50</span></span>
                <span id="ui-stage" style="color:var(--rare)">ç·´æ°£æœŸ</span>
            </div>
        </div>
    </div>

    <!-- Chart -->
    <div id="chart-area">
        <canvas id="kline-canvas"></canvas>
        <div id="stock-overlay">
            <div class="stock-title" id="stock-name">LOADING...</div>
            <div class="stock-sub" id="stock-sub">TECH | VOL: HIGH</div>
        </div>
    </div>

    <!-- News -->
    <div id="news-marquee">
        <span id="news-tag" class="news-tag">NEWS</span>
        <marquee scrollamount="5" id="news-text">æ­¡è¿é€²å…¥å¸‚å ´...</marquee>
    </div>

    <!-- Log -->
    <div id="log-area"></div>

    <!-- Inventory -->
    <div id="inventory"></div>

    <!-- Controls -->
    <div id="controls">
        <div class="control-group">
            <span style="font-size:12px; color:#aaa;">å€‰ä½æ§åˆ¶: <span id="pos-val" style="color:#fff; font-weight:bold;">20%</span></span>
            <input type="range" min="1" max="4" value="2" oninput="updatePos(this.value)">
        </div>
        
        <button class="btn-buy" onclick="trade('long')">åšå¤š (LONG)<br><span style="font-size:10px; opacity:0.7">çœ‹æ¼²è²·å…¥</span></button>
        <button class="btn-sell" onclick="trade('short')">åšç©º (SHORT)<br><span style="font-size:10px; opacity:0.7">çœ‹è·Œè³£å‡º</span></button>
        <button class="btn-skip" onclick="skipDay()">ç©ºå€‰è§€æœ› (æ¢å¾©ç‹€æ…‹)</button>
    </div>
</div>

<!-- End Screen -->
<div id="end-screen" class="modal hidden">
    <h1 id="end-title" style="color:var(--red)">ç ´ç”¢</h1>
    <p id="end-reason">ä½ å€’åœ¨äº†é»æ˜å‰ã€‚</p>
    <h2 id="end-score" style="color:var(--highlight)">$0</h2>
    <button onclick="location.reload()" style="background:#333; margin-top:20px;">è½‰ä¸–è¼ªè¿´</button>
</div>

<script>
/**
 * éŠæˆ²æ•¸æ“šåº« - å……æ»¿æƒ¡è¶£å‘³èˆ‡ç¶²è·¯æ¢—
 */
const DB = {
    names: ["éŸ­èœä¸€è™Ÿ", "å¤©å°VIP", "è¯çˆ¾è¡—ä¹‹ç‹¼", "å·´è²ç‰¹é–€å¾’", "æ¢­å“ˆå±…å£«", "è² äºŒä»£", "å…¬å±‹è‚¡ç¥", "å¹£åœˆé›£æ°‘", "æ‰“å·¥çš‡å¸", "é¹¹é­šç¿»èº«", "æ»¿å€‰è¸ç©º", "è€è³´é å‚™è»", "å¤¢æƒ³å®¶", "ç²¾ç¥è‚¡æ±", "æ¥ç›¤ä¿ "],
    
    // è‚¡ç¥¨åç¨±åº«
    stockPrefix: ["é‡å­", "å…ƒå®‡å®™", "æ·±æµ·", "ç«æ˜Ÿ", "è³½åš", "ç´ç±³", "è™›æ“¬", "å€å¡Š", "æ ¸èƒ½", "ç”ŸåŒ–", "æ™ºèƒ½", "6G", "è¶…å°"],
    stockSuffix: ["ç§‘æŠ€", "é‡å·¥", "é†«è—¥", "å¨›æ¨‚", "å‹•åŠ›", "èƒ½æº", "é£Ÿå“", "é˜²å‹™", "ç‰©æµ", "åœ°ç”¢"],
    
    // æ–°èåº« (Tag: 1=Good, -1=Bad, 0=Neutral)
    news: [
        {t: "CEOæ¶‰å«Œè©é¨™", c: "{name} CEO è¢«ç™¼ç¾æŒªç”¨å…¬æ¬¾å……å€¼æ‰‹æ¸¸ï¼Œè‚¡åƒ¹æ‰¿å£“ã€‚", v: -25, tag: -1},
        {t: "å·¥å» çˆ†ç‚¸", c: "{name} ä½æ–¼æ±å—äºçš„è¡€æ±—å·¥å» ç™¼ç”Ÿçˆ†ç‚¸ï¼Œç”¢èƒ½æ­¸é›¶ã€‚", v: -15, tag: -1},
        {t: "è²¡å ±é€ å‡", c: "å¯©è¨ˆç™¼ç¾ {name} çš„åˆ©æ½¤å…¨æ˜¯ Excel ç•«å‡ºä¾†çš„ã€‚", v: -30, tag: -1},
        {t: "ç”¢å“è‡ªç‡ƒ", c: "{name} çš„æ——è‰¦ç”¢å“è¢«æ›åœ¨ç”¨æˆ¶å£è¢‹ä¸­è‡ªç‡ƒã€‚", v: -10, tag: -1},
        {t: "è¢«åšç©º", c: "çŸ¥åæ©Ÿæ§‹ç™¼å¸ƒ {name} åšç©ºå ±å‘Šï¼šä¸€æ–‡ä¸å€¼ã€‚", v: -20, tag: -1},
        {t: "æŠ€è¡“çªç ´", c: "{name} å®£ç¨±ç ”ç™¼å‡ºæ°¸å‹•æ©Ÿï¼ˆé›–ç„¶æ²’äººä¿¡ï¼‰ã€‚", v: 15, tag: 1},
        {t: "è¢«æ”¶è³¼", c: "å‚³èé¦¬æ–¯å…‹æœ‰æ„æ”¶è³¼ {name}ï¼Œç›¤å‰å¤§æ¼²ã€‚", v: 25, tag: 1},
        {t: "æ”¿åºœè£œè²¼", c: "{name} ç²å¾—åœ‹å®¶ç´šã€Œå°ˆç²¾ç‰¹æ–°ã€å·¨é¡è£œè²¼ã€‚", v: 10, tag: 1},
        {t: "ç”¢å“çˆ†ç´…", c: "{name} çš„æ–°å“åœ¨ TikTok ä¸Šçˆ†ç´…ï¼Œå…¨çƒæ–·è²¨ã€‚", v: 20, tag: 1},
        {t: "AIåŠ æŒ", c: "{name} å®£å¸ƒå…¨ç·šç”¢å“æ¥å…¥ ChatGPTï¼Œè‚¡æ°‘é«˜æ½®ã€‚", v: 15, tag: 1},
        {t: "å¹³æ·¡ç„¡å¥‡", c: "{name} ä»Šæ—¥ç„¡äº‹ç™¼ç”Ÿï¼Œå“¡å·¥åœ¨æ‘¸é­šã€‚", v: 0, tag: 0},
        {t: "é«˜å±¤å…§é¬¥", c: "{name} å‰µå§‹äººèˆ‡è¯åˆå‰µå§‹äººåœ¨è¾¦å…¬å®¤äº’æ¯†ã€‚", v: -5, tag: -1},
        {t: "ç¥ç§˜è¨‚å–®", c: "ä¸­æ±åœŸè±ªå‘ {name} ä¸‹äº†ä¸€ç­†ç¥ç§˜å¤§å–®ã€‚", v: 10, tag: 1}
    ],

    // å¥‡é‡äº‹ä»¶ (Event)
    events: [
        {
            title: "å…§å¹•æ¶ˆæ¯", text: "ä½ åœ¨å»æ‰€è½åˆ°å…©å€‹å¤§ä½¬è«‡è«–ä»£ç¢¼ã€‚",
            opts: [{t:"å·è½", f: (s)=>{ s.nextWin=true; return "ç²å¾—å¿…å‹æƒ…å ±ï¼"; }}, {t:"ç„¡è¦–", f: (s)=>{ s.stress-=10; return "å¿ƒå¦‚æ­¢æ°´ï¼Œå£“åŠ›-10"; }}]
        },
        {
            title: "æ®ºè±¬ç›¤", text: "ç¾å¥³é ­åƒç¶²å‹åŠ ä½ ï¼Œæ¨è–¦ã€Œç©©è³ºã€é …ç›®ã€‚",
            opts: [{t:"ç›¸ä¿¡å¥¹", f: (s)=>{ s.money*=0.5; s.stress+=20; return "è¢«é¨™äº†ä¸€åŠèº«å®¶ï¼"; }}, {t:"æ‹‰é»‘", f: (s)=>{ s.luck+=5; return "æ™ºå•†ä½”é ˜é«˜åœ°ï¼Œé‹æ°£+5"; }}]
        },
        {
            title: "ç³»çµ±BUG", text: "äº¤æ˜“è»Ÿä»¶å‡ºç¾æ¼æ´ï¼Œé¡¯ç¤ºé¤˜é¡å¤šäº†ä¸€å€‹é›¶ã€‚",
            opts: [{t:"åˆ©ç”¨BUG", f: (s)=>{ if(Math.random()>0.5){s.money+=50000; return "ç™½å«–æˆåŠŸï¼+$50000";}else{s.money-=20000; return "è¢«ç³»çµ±åå‘æ‰£æ¬¾ç½°é‡‘ï¼";} }}, {t:"å ±å‘Š", f: (s)=>{ s.happy+=10; return "ç²å¾—ã€Œå¥½å¸‚æ°‘ã€ç¨±è™Ÿï¼Œå¿«æ¨‚+10"; }}]
        },
        {
            title: "ç„å­¸å¤§å¸«", text: "å¤§å¸«èªªä½ å°å ‚ç™¼é»‘ï¼Œéœ€ç ´è²¡æ“‹ç½ã€‚",
            opts: [{t:"çµ¦éŒ¢ $5000", f: (s)=>{ s.money-=5000; s.luck+=20; return "æ„Ÿè¦ºé‹æ°£è®Šå¥½äº†ï¼"; }}, {t:"æ»¾", f: (s)=>{ s.luck-=10; return "å‡ºé–€è¸©åˆ°ç‹—å±ï¼Œé‹æ°£-10"; }}]
        }
    ],

    // ç‰©å“/æŠ€èƒ½
    items: {
        "insider": {icon:"ğŸ“±", name:"å…§å¹•æ‰‹æ©Ÿ", desc:"ä½¿ç”¨å¾Œä¸‹ä¸€æ¬¡äº¤æ˜“å¼·åˆ¶ç²åˆ©"},
        "pill": {icon:"ğŸ’Š", name:"å¾Œæ‚”è—¥", desc:"å›å¾©æ‰€æœ‰å¿«æ¨‚èˆ‡å£“åŠ›ï¼Œä¸¦é‡ç½®ä»Šæ—¥"},
        "elon": {icon:"ğŸš€", name:"é¦¬æ–¯å…‹æ¨æ–‡", desc:"å¼·åˆ¶è£½é€ è¶…ç´šåˆ©å¥½è¡Œæƒ…"},
        "coffee": {icon:"â˜•", name:"å†°ç¾å¼", desc:"å¿«æ¨‚+20ï¼Œå£“åŠ›-20"}
    },

    skills: [
        {id:"eye", name:"é€è¦–çœ¼", desc:"Kç·šåœ–æœƒé¡¯ç¤ºæœªä¾†ä¸€å¤©çš„è™›å½± (å‹ç‡å¤§å¹…æå‡)"},
        {id:"hands", name:"é‘½çŸ³æ‰‹", desc:"è™§ææ™‚ï¼Œå£“åŠ›å¢åŠ æ¸›åŠï¼›æŒæœ‰éå¤œæ”¶ç›Š+10%"},
        {id:"tax", name:"é¿ç¨…å°ˆç·š", desc:"æ¯æœˆçµç®—æ™‚ï¼Œç”Ÿæ´»è²»æ¸›å°‘ 50%"},
        {id:"whale", name:"å·¨é¯¨åå™¬", desc:"ç²åˆ©è¶…é $10000 æ™‚ï¼Œé¡å¤–ç²å¾— $5000 çé‡‘"},
        {id:"beggar", name:"ä¸å¹«", desc:"è³‡ç”¢ä½æ–¼ $10000 æ™‚ï¼Œæ¯æœˆè‡ªå‹•ç²å¾—æ•‘æ¿Ÿé‡‘"}
    ]
};

// éŠæˆ²ç‹€æ…‹
let state = {
    day: 1, money: 0, stress: 0, happy: 100, luck: 50,
    salary: 15000, cost: 10000, loan: 0,
    name: "", traits: [], skills: [], inventory: [],
    
    // å¸‚å ´ç‹€æ…‹
    stock: null, // {name, history[], volatility, news, trendVal}
    posPct: 0.2,
    daysWithoutEvent: 0,
    nextWin: false,
    
    // åœ–è¡¨å¯¦ä¾‹
    ctx: null
};

// å·¥å…·å‡½æ•¸
const rand = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
const formatMoney = (n) => "$" + Math.floor(n).toLocaleString();

/* --- åˆå§‹åŒ– --- */
function init() {
    state.ctx = document.getElementById('kline-canvas').getContext('2d');
    randomName();
    renderTraits();
}

function randomName() {
    document.getElementById('input-name').value = DB.names[rand(0, DB.names.length-1)];
}

function renderTraits() {
    const list = [
        {t:"å¯ŒäºŒä»£", d:"é–‹å±€ +$20è¬ï¼Œç„¡å­¸è²¸", func: s=>{s.money=200000;}},
        {t:"è² å‚µè³­ç‹—", d:"é–‹å±€ +$50è¬ï¼Œæ¯æœˆé‚„è²¸$1è¬", func: s=>{s.money=500000; s.loan=10000;}},
        {t:"æ‰“å·¥çš‡å¸", d:"å·¥è³‡ç¿»å€ ($30000)", func: s=>{s.salary=30000;}},
        {t:"æ­çš‡", d:"åˆå§‹é‹æ°£ 90ï¼Œå®¹æ˜“è§¸ç™¼å¥½äº‹", func: s=>{s.luck=90;}},
        {t:"é¢ç™±", d:"å£“åŠ›æ†å®šç‚º 0ï¼Œå¿«æ¨‚æ†å®š 50", func: s=>{s.stressLock=true; s.happyLock=true; s.happy=50;}},
        {t:"å…§å¹•ç‹—", d:"é–‹å±€è‡ªå¸¶ 3 å€‹å…§å¹•æ‰‹æ©Ÿ", func: s=>{s.inventory.push('insider','insider','insider');}}
    ];
    
    const div = document.getElementById('trait-list');
    div.innerHTML = "";
    list.forEach((item, idx) => {
        let el = document.createElement('div');
        el.className = 'choice-card';
        el.innerHTML = `<h3>${item.t}</h3><p>${item.d}</p>`;
        el.onclick = () => {
            if(el.classList.contains('selected')) el.classList.remove('selected');
            else if(document.querySelectorAll('.choice-card.selected').length < 2) el.classList.add('selected');
        };
        el.data = item;
        div.appendChild(el);
    });
}

function startGame() {
    const sels = document.querySelectorAll('.choice-card.selected');
    if(sels.length !== 2) return alert("è«‹é¸æ“‡ 2 å€‹å¤©è³¦ï¼");
    
    state.name = document.getElementById('input-name').value;
    if(state.money === 0) state.loan = 0; // Reset if default

    sels.forEach(el => el.data.func(state));
    
    // è‹¥æ²’é¸éŒ¢ï¼Œçµ¦é»˜èª
    if(state.money === 0) {
        if(confirm("æ˜¯å¦ç”³è«‹åŠ©å­¸è²¸æ¬¾ $200,000 (æœˆé‚„$5000)?\nå–æ¶ˆå‰‡ç‚º $0 é–‹å±€æ‰“å·¥ã€‚")) {
            state.money = 200000; state.loan = 5000;
        }
    }

    document.getElementById('start-screen').classList.add('hidden');
    document.getElementById('game-container').classList.remove('hidden');
    
    log(`è³¬æˆ¶åˆå§‹åŒ–å®Œæˆã€‚æ­¡è¿ä½ ï¼Œ${state.name}ã€‚`);
    nextDay();
}

/* --- æ ¸å¿ƒå¾ªç’° --- */
function nextDay() {
    state.day++;
    state.daysWithoutEvent++;
    
    // 1. æœˆçµ
    if(state.day % 30 === 0) {
        monthlySettle();
        return; // æœˆçµå¾Œæš«åœç­‰å¾…æ“ä½œ
    }

    // 2. ç”Ÿæˆæ–°è‚¡ç¥¨
    generateStock();

    // 3. æ›´æ–°UI
    updateUI();
    drawChart();

    // 4. äº‹ä»¶æª¢æŸ¥ (æ¯10å¤©ä¿åº•ï¼Œæˆ–éš¨æ©Ÿ)
    if(state.daysWithoutEvent >= 8 || Math.random() < 0.15) {
        triggerEvent();
    }
}

function monthlySettle() {
    let cost = state.cost;
    if(state.skills.includes("tax")) cost /= 2;
    
    let income = state.salary;
    let loan = state.loan;
    
    if(state.skills.includes("beggar") && state.money < 10000) {
        income += 5000;
        log("ã€ä¸å¹«ã€‘è§¸ç™¼ï¼Œé ˜å–æ•‘æ¿Ÿé‡‘ $5000");
    }

    state.money += (income - cost - loan);
    log(`ã€æœˆçµã€‘å·¥è³‡+${income}, ç”Ÿæ´»è²»-${cost}, é‚„è²¸-${loan}`);
    
    // å‡ç´šé¸æ“‡
    showLevelUp();
}

function showLevelUp() {
    document.getElementById('levelup-screen').classList.remove('hidden');
    const box = document.getElementById('skill-choices');
    box.innerHTML = "";
    
    // éš¨æ©Ÿé¸3å€‹æŠ€èƒ½æˆ–ç‰©å“
    let pool = [...DB.skills]; // æ·ºæ‹·è²
    let opts = [];
    for(let i=0; i<3; i++) {
        if(pool.length === 0) break;
        let idx = rand(0, pool.length-1);
        opts.push(pool[idx]);
        pool.splice(idx, 1);
    }
    
    opts.forEach(s => {
        let el = document.createElement('div');
        el.className = 'choice-card';
        el.innerHTML = `<h3 style="color:var(--rare)">${s.name}</h3><p>${s.desc}</p>`;
        el.onclick = () => {
            state.skills.push(s.id);
            log(`ç¿’å¾—æŠ€èƒ½ï¼š${s.name}`);
            document.getElementById('levelup-screen').classList.add('hidden');
            nextDay(); // ç¹¼çºŒä¸‹ä¸€å¤©
        };
        box.appendChild(el);
    });
}

/* --- å¸‚å ´èˆ‡Kç·šç³»çµ± --- */
function generateStock() {
    let name = DB.stockPrefix[rand(0, DB.stockPrefix.length-1)] + DB.stockSuffix[rand(0, DB.stockSuffix.length-1)];
    let volatility = rand(2, 8); // åŸºç¤æ³¢å‹•
    let trend = rand(-1, 1); // -1è·Œ, 0éœ‡ç›ª, 1æ¼²
    
    // ç”Ÿæˆæ­·å² K ç·š (30å¤©)
    let history = [];
    let price = rand(50, 200);
    
    for(let i=0; i<30; i++) {
        let change = (Math.random() - 0.5 + (trend * 0.1)) * volatility;
        let open = price;
        let close = open * (1 + change/100);
        let high = Math.max(open, close) * (1 + Math.random()*0.02);
        let low = Math.min(open, close) * (1 - Math.random()*0.02);
        
        history.push({o:open, h:high, l:low, c:close});
        price = close;
    }

    // æ±ºå®šä»Šæ—¥æ–°è (å½±éŸ¿æ˜æ—¥çµæœ)
    let newsItem = DB.news[rand(0, DB.news.length-1)];
    
    // æŠ€èƒ½å½±éŸ¿ (é€è¦–çœ¼)
    let futureTrend = 0;
    if(state.skills.includes("eye")) {
        // ç°¡å–®æç¤º
        document.getElementById('stock-sub').innerText += " [é€è¦–: " + (newsItem.v > 0 ? "æ¼²" : "è·Œ") + "]";
    }

    state.stock = {
        name: name,
        history: history,
        news: newsItem,
        volatility: volatility,
        currentPrice: price
    };
}

function drawChart() {
    const ctx = state.ctx;
    const canvas = document.getElementById('kline-canvas');
    // Resize
    canvas.width = document.getElementById('chart-area').offsetWidth;
    canvas.height = document.getElementById('chart-area').offsetHeight;
    
    const W = canvas.width;
    const H = canvas.height;
    const data = state.stock.history;
    const count = data.length;
    const barW = (W - 40) / count;
    
    // Find Min/Max for scaling
    let min = 99999, max = 0;
    data.forEach(d => {
        if(d.l < min) min = d.l;
        if(d.h > max) max = d.h;
    });
    let range = max - min;
    const getY = (p) => H - 20 - ((p - min) / range) * (H - 40);

    ctx.clearRect(0,0,W,H);
    
    // Grid
    ctx.strokeStyle = "#222";
    ctx.beginPath();
    for(let i=0; i<5; i++) {
        let y = H/5 * i;
        ctx.moveTo(0, y); ctx.lineTo(W, y);
    }
    ctx.stroke();

    // Draw Candles
    data.forEach((d, i) => {
        let x = 10 + i * barW;
        let yO = getY(d.o);
        let yC = getY(d.c);
        let yH = getY(d.h);
        let yL = getY(d.l);
        
        let isUp = d.c >= d.o;
        ctx.fillStyle = isUp ? "#ff7b72" : "#3fb950"; // ç´…æ¼²ç¶ è·Œ
        ctx.strokeStyle = ctx.fillStyle;
        
        // Line
        ctx.beginPath();
        ctx.moveTo(x + barW/2, yH);
        ctx.lineTo(x + barW/2, yL);
        ctx.stroke();
        
        // Rect
        let h = Math.abs(yC - yO);
        if(h < 1) h = 1;
        ctx.fillRect(x + 2, Math.min(yO, yC), barW - 4, h);
    });
}

/* --- äº¤æ˜“èˆ‡æ“ä½œ --- */
function updatePos(val) {
    const pcts = [0.05, 0.2, 0.5, 1.0];
    state.posPct = pcts[val-1];
    document.getElementById('pos-val').innerText = (state.posPct * 100) + "%";
}

function trade(type) {
    // æª¢æŸ¥å¿ƒæ…‹å¤±æ§
    if(!state.stressLock && state.stress > 90) {
        if(Math.random() < 0.5) {
            log("ğŸ›‘ å£“åŠ›éå¤§ï¼ä½ çš„æ‰‹ä¸è½ä½¿å–šï¼(éš¨æ©Ÿæ“ä½œ)");
            type = Math.random() > 0.5 ? 'long' : 'short';
        }
    }

    let bet = state.money * state.posPct;
    if(bet < 100) bet = state.money; // All in if poor
    if(state.money <= 0) return alert("æ²’éŒ¢äº†ï¼");

    // è¨ˆç®—çµæœ
    let s = state.stock;
    let impact = s.news.v + (state.luck - 50)*0.2; // æ–°è+é‹æ°£
    
    // ç¥å™¨æ•ˆæœ
    if(state.nextWin) { impact = 100; state.nextWin = false; log("ğŸ“± å…§å¹•æ¶ˆæ¯ç”Ÿæ•ˆï¼"); }
    
    let changePct = (Math.random() * s.volatility + impact/5); // å¯¦éš›æ¼²è·Œå¹…
    // ç°¡å–®æ¨¡æ“¬ï¼šå¦‚æœ impact > 0 å‚¾å‘æ¼²
    let dir = 1;
    if(Math.random()*100 > (50 + impact)) dir = -1;
    
    let finalChange = dir * Math.abs(changePct);
    
    // çµç®—
    let pnl = 0;
    if(type === 'long') pnl = bet * (finalChange / 100);
    else pnl = bet * (-finalChange / 100);

    // æŠ€èƒ½ä¿®æ­£
    if(pnl < 0 && state.skills.includes("hands")) {
        pnl *= 0.9; // è™§ææ¸›å°‘
        state.stress -= 5; // é‘½çŸ³æ‰‹å¿ƒæ…‹å¥½
    }
    if(pnl > 10000 && state.skills.includes("whale")) {
        state.money += 5000;
        log("ğŸ‹ å·¨é¯¨åå™¬ï¼é¡å¤–çå‹µ $5000");
    }

    state.money += pnl;

    // å¿ƒæ…‹å½±éŸ¿
    if(pnl > 0) {
        logItem(`äº¤æ˜“ ${s.name}: ç›ˆåˆ© ${formatMoney(pnl)} (${finalChange.toFixed(2)}%)`, 'profit');
        changeState(-5, 5); // å£“- å¿«+
    } else {
        logItem(`äº¤æ˜“ ${s.name}: è™§æ ${formatMoney(Math.abs(pnl))} (${finalChange.toFixed(2)}%)`, 'loss');
        changeState(10, -5);
    }

    checkEnd();
    nextDay();
}

function skipDay() {
    log("â˜• ä½ é¸æ“‡ç©ºå€‰è§€æœ›ï¼Œèª¿æ•´å¿ƒæ…‹ã€‚");
    changeState(-10, 10);
    nextDay();
}

function triggerEvent() {
    state.daysWithoutEvent = 0;
    let evt = DB.events[rand(0, DB.events.length-1)];
    
    // ç°¡å–®ä½¿ç”¨ confirm æ¨¡æ“¬å½ˆçª—ï¼Œæˆ–è€…ç›´æ¥ Log
    // ç‚ºäº†æµæš¢ï¼Œé€™è£¡ç›´æ¥å¯«å…¥ Log ä¸¦æä¾›æŒ‰éˆ• (ç¨å¾®è¤‡é›œï¼Œé€™è£¡ç°¡åŒ–ç‚ºéš¨æ©Ÿè‡ªå‹•æˆ–å½ˆçª—)
    // é€™è£¡ç”¨ prompt æ¨¡æ“¬é¸æ“‡ (ä¸å¤ å¥½çœ‹)ï¼Œæ”¹ç‚ºç”¨ Log å€é¡¯ç¤ºå¯é»æ“Šéˆæ¥ (HTML)
    
    let div = document.createElement('div');
    div.className = 'log-item';
    div.style.borderLeftColor = 'var(--rare)';
    div.innerHTML = `<strong style="color:var(--rare)">[å¥‡é‡] ${evt.title}</strong><br>${evt.text}<br>`;
    
    evt.opts.forEach((opt, idx) => {
        let btn = document.createElement('button');
        btn.innerText = opt.t;
        btn.style.marginRight = "5px";
        btn.style.padding = "4px 8px";
        btn.style.fontSize = "11px";
        btn.style.marginTop = "5px";
        btn.onclick = function() {
            let res = opt.f(state);
            log(`> é¸æ“‡äº† [${opt.t}]: ${res}`);
            div.remove(); // ç§»é™¤é¸é …
            updateUI();
        };
        div.appendChild(btn);
    });
    
    document.getElementById('log-area').prepend(div);
}

/* --- ç³»çµ±èˆ‡UI --- */
function updateUI() {
    document.getElementById('ui-money').innerText = formatMoney(state.money);
    document.getElementById('ui-income').innerText = (state.salary - state.cost - state.loan > 0 ? "+" : "") + formatMoney(state.salary - state.cost - state.loan);
    document.getElementById('ui-day').innerText = state.day;
    document.getElementById('ui-luck').innerText = state.luck;
    
    // Bars
    document.getElementById('bar-stress').style.width = state.stress + "%";
    document.getElementById('bar-happy').style.width = state.happy + "%";
    
    // Market Info
    let s = state.stock;
    document.getElementById('stock-name').innerText = s.name;
    document.getElementById('stock-sub').innerText = "VOLATILITY: " + s.volatility + "%";
    
    let newsHTML = `<span class="news-tag ${s.news.tag===1?'good':''}">NEWS</span> ${s.news.c.replace("{name}", s.name)}`;
    document.getElementById('news-marquee').innerHTML = newsHTML;
    
    // Inventory
    let invDiv = document.getElementById('inventory');
    invDiv.innerHTML = "";
    // é€™è£¡ç°¡åŒ–ï¼šé»æ“Šç‰©å“ç›´æ¥ä½¿ç”¨
    state.inventory.forEach((itemId, idx) => {
        let item = DB.items[itemId];
        let el = document.createElement('div');
        el.className = 'item';
        el.innerText = item.icon;
        el.title = item.name + ": " + item.desc;
        el.onclick = () => useItem(itemId, idx);
        invDiv.appendChild(el);
    });
}

function useItem(id, idx) {
    if(id === "insider") { state.nextWin = true; log("ä½¿ç”¨å…§å¹•æ‰‹æ©Ÿ: ä¸‹æ¬¡å¿…å‹"); }
    if(id === "pill") { state.happy=100; state.stress=0; log("æœç”¨å¾Œæ‚”è—¥: ç‹€æ…‹å…¨æ»¿"); }
    if(id === "elon") { state.stock.news = {v:50, tag:1, c:"é¦¬æ–¯å…‹å–Šå–®ï¼"}; updateUI(); log("é¦¬æ–¯å…‹ç™¼æ¨äº†ï¼"); }
    if(id === "coffee") { changeState(-20, 20); log("å–äº†æ¯å’–å•¡"); }
    
    state.inventory.splice(idx, 1);
    updateUI();
}

function changeState(s, h) {
    if(!state.stressLock) state.stress = Math.max(0, Math.min(100, state.stress + s));
    if(!state.happyLock) state.happy = Math.max(0, Math.min(100, state.happy + h));
}

function logItem(msg, type='') {
    let d = document.createElement('div');
    d.className = `log-item ${type}`;
    d.innerHTML = `Day ${state.day}: ${msg}`;
    document.getElementById('log-area').prepend(d);
}
function log(msg) { logItem(msg); }

function checkEnd() {
    if(state.money >= 100000000) endGame("è²¡å¯Œè‡ªç”±", "ä½ æˆç‚ºäº†å‚³å¥‡ï¼", state.money);
    else if(state.money < -50000) endGame("è·³æ¨“çµç®—", "è³‡ä¸æŠµå‚µï¼Œå†è¦‹äº†ä¸–ç•Œã€‚", state.money);
}

function endGame(title, reason, score) {
    document.getElementById('end-screen').classList.remove('hidden');
    document.getElementById('end-title').innerText = title;
    document.getElementById('end-reason').innerText = reason;
    document.getElementById('end-score').innerText = formatMoney(score);
}

// Start
init();

</script>
</body>
</html>

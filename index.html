<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é‡‘èä¿ å®¢ä¿®ä»™éŒ„ï¼šé£›å‡ç‰ˆ</title>
    <style>
        :root {
            --bg-color: #121212;
            --panel-bg: #1e1e1e;
            --text-color: #e0e0e0;
            --highlight: #f1c40f;
            --rare: #9b59b6; /* ç´«è‰²ç¥å™¨ */
            --legendary: #e67e22; /* æ©™è‰²å‚³èªª */
            --red: #ff4d4d; 
            --green: #2ecc71;
            --btn-bg: #2c3e50;
        }

        body {
            font-family: 'Microsoft JhengHei', monospace;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            height: 100vh;
            overflow: hidden;
            user-select: none;
        }

        /* æ»¾å‹•æ¢æ¨£å¼ */
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-thumb { background: #555; border-radius: 3px; }

        #game-container {
            width: 100%;
            max-width: 600px;
            background-color: var(--bg-color);
            display: flex;
            flex-direction: column;
            border-left: 1px solid #333;
            border-right: 1px solid #333;
            position: relative;
        }

        /* é ‚éƒ¨ç‹€æ…‹æ¬„ */
        #header {
            padding: 10px;
            background: linear-gradient(to bottom, #2c3e50, #1a1a1a);
            border-bottom: 2px solid #000;
            font-size: 13px;
        }
        .top-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .big-money { font-size: 18px; color: var(--highlight); font-weight: bold; }
        
        .attr-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px; text-align: center; font-size: 12px; background: #222; padding: 5px; border-radius: 5px; }
        .attr-item span { display: block; font-weight: bold; }

        /* ä¸­é–“æ—¥èªŒå€ */
        #log-area {
            flex-grow: 1;
            padding: 15px;
            overflow-y: auto;
            font-size: 14px;
            background: #121212;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .log-entry { 
            padding: 8px; 
            border-bottom: 1px solid #222; 
            animation: fadeIn 0.3s;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .log-date { color: #666; font-size: 11px; margin-right: 5px; }
        .sys-msg { color: #aaa; font-style: italic; }
        .profit { color: var(--red); }
        .loss { color: var(--green); }
        
        /* å¸‚å ´é¢æ¿ */
        #market-panel {
            background-color: var(--panel-bg);
            padding: 10px;
            border-top: 1px solid #333;
        }
        .stock-card {
            background: #252525; padding: 12px; border-radius: 8px; border: 1px solid #444;
            position: relative;
        }
        .stock-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .stock-name { font-size: 20px; color: var(--highlight); font-weight: bold; }
        .win-rate { font-size: 12px; color: #aaa; background: #111; padding: 2px 6px; border-radius: 4px;}
        
        .k-line { display: flex; gap: 10px; font-size: 12px; color: #888; margin-bottom: 8px; }
        .news-ticker { 
            background: rgba(0,0,0,0.3); padding: 5px; font-size: 13px; color: #ddd; 
            border-left: 3px solid var(--highlight);
        }

        /* ç‰©å“æ¬„ (æ©«å‘æ»¾å‹•) */
        #inventory-bar {
            display: flex;
            gap: 8px;
            padding: 8px 10px;
            background: #181818;
            overflow-x: auto;
            white-space: nowrap;
            height: 60px;
            border-top: 1px solid #333;
        }
        .item-slot {
            min-width: 50px; height: 50px;
            background: #333; border: 1px solid #555;
            border-radius: 5px;
            display: flex; justify-content: center; align-items: center;
            font-size: 20px; cursor: pointer;
            position: relative;
        }
        .item-slot:hover { border-color: var(--highlight); }
        .item-count { position: absolute; bottom: 0; right: 2px; font-size: 10px; color: #fff; }

        /* æ“ä½œå€ */
        #controls {
            padding: 10px;
            background: #111;
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }
        .pos-slider-container {
            grid-column: span 2; display: flex; align-items: center; gap: 10px; font-size: 12px; margin-bottom: 5px;
        }
        input[type=range] { flex-grow: 1; accent-color: var(--highlight); }

        button {
            padding: 12px; border: none; border-radius: 6px; color: white; font-weight: bold; cursor: pointer;
            position: relative; overflow: hidden;
        }
        .btn-long { background: linear-gradient(45deg, #c0392b, #e74c3c); }
        .btn-short { background: linear-gradient(45deg, #27ae60, #2ecc71); }
        .btn-skip { grid-column: span 2; background: #555; color: #ccc; padding: 8px; }
        
        .rate-badge {
            position: absolute; top: 2px; right: 2px; font-size: 10px; background: rgba(0,0,0,0.4); padding: 1px 3px; border-radius: 3px;
        }

        /* å½ˆçª— */
        .overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95);
            z-index: 100;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 20px; box-sizing: border-box;
            backdrop-filter: blur(5px);
        }
        .hidden { display: none !important; }

        .card-container { display: grid; grid-template-columns: 1fr; gap: 10px; width: 100%; max-height: 80vh; overflow-y: auto;}
        .card {
            background: #2c3e50; padding: 15px; border: 1px solid #444; border-radius: 8px;
            cursor: pointer; transition: transform 0.1s; text-align: left;
        }
        .card:hover { transform: scale(1.02); border-color: var(--highlight); }
        .card h3 { margin: 0 0 5px 0; color: var(--highlight); }
        .card p { margin: 0; font-size: 13px; color: #ccc; }
        
        .rogue-title { color: var(--rare); margin-bottom: 20px; text-shadow: 0 0 10px var(--rare); }

        /* å‹•æ•ˆ */
        .pop { animation: pop 0.2s; }
        @keyframes pop { 50% { transform: scale(1.1); } }
    </style>
</head>
<body>

    <!-- å•Ÿå‹•èˆ‡å¤©è³¦ -->
    <div id="start-screen" class="overlay">
        <h1>é‡‘èä¿ å®¢ä¿®ä»™éŒ„ <span style="font-size:12px; color:var(--highlight)">é£›å‡ç‰ˆ</span></h1>
        <p>è«‹è¼¸å…¥é“è™Ÿï¼ˆåå­—ï¼‰ï¼š</p>
        <input type="text" id="player-name" value="éŸ­èœä¸€è™Ÿ" style="padding:10px; font-size:16px; margin-bottom:15px; background:#333; color:#fff; border:1px solid #555;">
        <p>é¸æ“‡å…©é …å…ˆå¤©éˆæ ¹ï¼ˆå¤©è³¦ï¼‰ï¼š</p>
        <div id="trait-selection" class="card-container" style="grid-template-columns: 1fr 1fr;"></div>
        <button onclick="confirmStart()" style="width:100%; margin-top:15px; background:var(--highlight); color:#000;">é–‹å§‹ä¿®ä»™</button>
    </div>

    <!-- å‡ç´š/Roguelike ä¸‰é¸ä¸€ -->
    <div id="levelup-screen" class="overlay hidden">
        <h2 class="rogue-title">å¢ƒç•Œçªç ´</h2>
        <p>æœ¬æœˆä¿®è¡ŒçµæŸï¼Œè«‹é¸æ“‡ä¸€é …åŠŸæ³•ç²¾é€²ï¼š</p>
        <div id="upgrade-choices" class="card-container"></div>
    </div>

    <!-- ç‰©å“è©³æƒ…å½ˆçª— -->
    <div id="item-modal" class="overlay hidden" style="background:rgba(0,0,0,0.8);">
        <div style="background:#222; padding:20px; border-radius:10px; border:1px solid var(--highlight); max-width:300px;">
            <h3 id="modal-item-name" style="color:var(--highlight)"></h3>
            <p id="modal-item-desc" style="margin:15px 0; color:#ddd;"></p>
            <div style="display:flex; gap:10px;">
                <button onclick="useItemConfirm()" style="background:var(--green); flex:1;">ä½¿ç”¨</button>
                <button onclick="closeModal()" style="background:#555; flex:1;">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- éŠæˆ²ä¸»é«” -->
    <div id="game-container" class="hidden">
        <div id="header">
            <div class="top-row">
                <span id="player-display">ç©å®¶</span>
                <span>ä¿®ç‚º: <span id="val-stage" style="color:var(--rare)">ç·´æ°£æœŸ</span></span>
                <span>Day <span id="val-day">1</span></span>
            </div>
            <div class="top-row">
                <div class="big-money" id="val-money">$0</div>
                <div style="font-size:12px; color:#888;">ç›®æ¨™: $1å„„</div>
            </div>
            <div class="attr-grid">
                <div class="attr-item" style="color:#e74c3c">å£“åŠ› <span id="val-stress">0</span></div>
                <div class="attr-item" style="color:#f1c40f">å¿«æ¨‚ <span id="val-happy">100</span></div>
                <div class="attr-item" style="color:#3498db">é‹æ°£ <span id="val-luck">50</span></div>
            </div>
        </div>

        <div id="log-area">
            <div class="log-entry sys-msg">æ­¡è¿ä¾†åˆ°é‡‘èå¸‚å ´ï¼Œå¤§é“ç„¡æƒ…ï¼Œé€™æ˜¯ä¸€å ´ä¿®ç¾…å ´ã€‚</div>
        </div>

        <div id="market-panel">
            <div class="stock-card">
                <div class="stock-header">
                    <span class="stock-name" id="stock-name">---</span>
                    <span class="win-rate" id="insight-display">å‹ç‡: ???</span>
                </div>
                <div class="k-line">
                    <span>5æ—¥: <span id="t-5">--</span></span>
                    <span>1æœˆ: <span id="t-30">--</span></span>
                    <span>1å¹´: <span id="t-365">--</span></span>
                </div>
                <div class="news-ticker" id="news-text">å¸‚å ´æ¶ˆæ¯è¼‰å…¥ä¸­...</div>
            </div>
        </div>

        <!-- ç‰©å“æ¬„ -->
        <div id="inventory-bar"></div>

        <div id="controls">
            <div class="pos-slider-container">
                <span>å€‰ä½: <span id="pos-display">20%</span></span>
                <input type="range" id="pos-slider" min="1" max="4" value="2" oninput="updatePosDisplay()">
            </div>
            
            <button class="btn-long" onclick="trade('long')">
                åšå¤š (Long)
                <div class="rate-badge" id="rate-long">--%</div>
            </button>
            <button class="btn-short" onclick="trade('short')">
                åšç©º (Short)
                <div class="rate-badge" id="rate-short">--%</div>
            </button>
            <button class="btn-skip" onclick="trade('skip')">ç©ºå€‰è§€æœ› (æ¢å¾©å¿«æ¨‚/å£“åŠ›)</button>
        </div>
    </div>

    <!-- çµå±€ -->
    <div id="end-screen" class="overlay hidden">
        <h1 id="end-title"></h1>
        <p id="end-reason" style="margin:20px 0; color:#ccc;"></p>
        <p>æœ€çµ‚è³‡ç”¢: <span id="end-money" style="color:var(--highlight); font-size:24px;"></span></p>
        <button onclick="location.reload()" style="padding:15px 30px; font-size:18px;">è½‰ä¸–é‡ä¿®</button>
    </div>

<script>
/* --- æ•¸æ“šçµæ§‹èˆ‡å¸¸é‡ --- */
const CONFIG = {
    GOAL: 100000000,
    BASE_COST: 10000,
    LOAN_REPAY: 5000,
    SALARY: 15000
};

// ç‰©å“åº«
const ITEM_DB = {
    "insider_phone": { name: "å…§å¹•æ‰‹æ©Ÿ", icon: "ğŸ“±", desc: "å·è½èŠå®¶é›»è©±ï¼Œä¸‹ä¸€æ¬¡äº¤æ˜“å¼·åˆ¶ç²åˆ©ã€‚", rarity: "legendary" },
    "stress_pill": { name: "é€é™ä¸¹", icon: "ğŸ’Š", desc: "å£“åŠ›æ­¸é›¶ï¼Œå¿«æ¨‚å›æ»¿ï¼Œæ„Ÿå—é£›ä¸€èˆ¬çš„æ„Ÿè¦ºã€‚", rarity: "common" },
    "elon_tweet": { name: "é¦¬æ–¯å…‹æ¨æ–‡", icon: "ğŸ¦", desc: "ç™¼å‹•å¾Œï¼Œä»Šæ—¥è‚¡ç¥¨å¼·åˆ¶æš´æ¼²(åˆ©å¥½)ã€‚", rarity: "rare" },
    "short_report": { name: "åšç©ºå ±å‘Š", icon: "ğŸ“‰", desc: "ç™¼å¸ƒè™›å‡å ±å‘Šï¼Œä»Šæ—¥è‚¡ç¥¨å¼·åˆ¶æš´è·Œ(åˆ©ç©º)ã€‚", rarity: "rare" },
    "lucky_charm": { name: "è½‰é‹ç¬¦", icon: "ğŸ§§", desc: "æ°¸ä¹…å¢åŠ  5 é»é‹æ°£ã€‚", rarity: "common" },
    "bailout": { name: "å¯Œå©†é€šè¨ŠéŒ„", icon: "ğŸ‘©", desc: "è³‡é‡‘ä½æ–¼1è¬æ™‚å¯ç”¨ï¼Œç²å¾— $50,000 è³‡åŠ©ã€‚", rarity: "rare" }
};

// æŠ€èƒ½/åŠŸæ³•åº« (Roguelike Upgrade)
const SKILLS_DB = [
    { id: "eye_1", name: "é™°é™½çœ¼ Lv.1", desc: "èƒ½æ¨¡ç³Šçœ‹åˆ°è‚¡ç¥¨çš„çœŸå¯¦å‹ç‡ã€‚", type: "insight", val: 1 },
    { id: "eye_2", name: "å¤©çœ¼é€š Lv.2", desc: "ç²¾ç¢ºæ´å¯Ÿè‚¡ç¥¨æ¼²è·Œæ©Ÿç‡ã€‚", type: "insight", val: 2 },
    { id: "calm_heart", name: "å†°å¿ƒè¨£", desc: "æ¯æœˆçµç®—æ™‚ï¼Œè‡ªå‹•æ¸…é™¤ 30% å£“åŠ›ã€‚", type: "passive", effect: "auto_stress" },
    { id: "diamond_hand", name: "é‘½çŸ³æ‰‹", desc: "å³ä½¿è™§æï¼Œå¿ƒæ…‹å‚·å®³æ¸›å°‘ 50%ã€‚", type: "passive", effect: "dmg_red" },
    { id: "salary_up", name: "æ‰“å·¥çš‡å¸", desc: "æ¯æœˆæ‰“å·¥/å·¥è³‡æ”¶å…¥ +50%ã€‚", type: "passive", effect: "salary_boost" },
    { id: "whale_eat", name: "èŠå®¶æ€ç¶­", desc: "ç²åˆ©æ™‚ï¼Œè³‡é‡‘å›å ±é¡å¤–å¢åŠ  10%ã€‚", type: "passive", effect: "profit_boost" },
    { id: "time_manage", name: "æ™‚é–“ç®¡ç†", desc: "æ¯æ—¥è¡Œå‹•æœ‰ 10% æ©Ÿç‡ä¸æ¶ˆè€—å¤©æ•¸ã€‚", type: "passive", effect: "free_turn" },
    { id: "beggar_sect", name: "ä¸å¹«å¿ƒæ³•", desc: "æ²’éŒ¢æ™‚(å°‘æ–¼5è¬)ï¼Œæ¯æœˆéš¨æ©Ÿç²å¾—ã€Œå–„æ¬¾ã€ã€‚", type: "passive", effect: "poverty_bonus" }
];

// éš¨æ©Ÿåç¨±
const STOCK_NAMES = ["å…ƒå®‡å®™", "é‡å­", "ç”Ÿç‰©", "æ–°èƒ½æº", "AI", "è¶…å°", "å€å¡Šéˆ", "å¤ªç©º", "èŠ¯ç‰‡", "é†«è—¥"];
const STOCK_SUFFIX = ["ç§‘æŠ€", "æ§è‚¡", "å¯¦æ¥­", "é›†åœ˜", "å‹•åŠ›", "æ™ºæ…§", "äº’å¨›"];

let state = {
    day: 1,
    money: 0,
    stress: 0,
    happy: 100,
    luck: 50,
    livingCost: CONFIG.BASE_COST,
    salary: CONFIG.SALARY,
    loan: 0,
    name: "",
    traits: [],
    inventory: [], // string ids
    skills: [], // active skill ids
    
    // è‡¨æ™‚ç‹€æ…‹
    insightLevel: 0, // 0=none, 1=vague, 2=exact
    nextTradeWin: false,
    forceTrend: 0, // 1=up, -1=down, 0=none
    currentStock: null,
    
    // çµ±è¨ˆ
    totalProfits: 0
};

/* --- æ ¸å¿ƒé‚è¼¯ --- */

function init() {
    renderTraits();
}

function renderTraits() {
    // éš¨æ©Ÿç”Ÿæˆç‰¹æ€§
    const traits = [
        {name: "å¤©ç”Ÿå¯ŒäºŒä»£", desc: "é–‹å±€è‡ªå¸¶ $20è¬ï¼Œç„¡å­¸è²¸ã€‚", money: 200000, loan: false},
        {name: "è² å‚µä¿®è¡Œ", desc: "é–‹å±€å€Ÿè²¸ $30è¬(æ›´å¤šæœ¬é‡‘)ï¼Œä½†å£“åŠ›å¤§ã€‚", money: 300000, loan: true, stress: 20},
        {name: "çµ•å°ç†æ€§", desc: "å£“åŠ›æ°¸é ç‚º0ï¼Œä½†å¿«æ¨‚ä¸Šé™50ã€‚", stressLock: true},
        {name: "æ­çš‡è½‰ä¸–", desc: "åˆå§‹é‹æ°£ 80ã€‚", luck: 80},
        {name: "éŸ­èœä¹‹ç‹", desc: "é‹æ°£ 10ï¼Œä½†åˆå§‹ç²å¾—ã€Œé€é™ä¸¹ã€x3ã€‚", luck: 10, items: ["stress_pill","stress_pill","stress_pill"]},
        {name: "å…§å¹•äº¤æ˜“å“¡", desc: "é–‹å±€ç²å¾—ã€Œå…§å¹•æ‰‹æ©Ÿã€ã€‚", items: ["insider_phone"]},
        {name: "æ‰“å·¥è–é«”", desc: "å·¥è³‡ç¿»å€ã€‚", salaryMult: 2},
        {name: "æˆ‘çˆ¸æ˜¯Elon", desc: "50%å¹¾ç‡ç›´æ¥å‹åˆ©ï¼Œ50%å¹¾ç‡ç ´ç”¢ä¸”é‹æ°£çˆ†æ£šã€‚", easterEgg: true}
    ];
    
    // æ´—ç‰Œå–6å€‹
    let pool = traits.sort(()=>0.5-Math.random()).slice(0,6);
    let container = document.getElementById('trait-selection');
    
    pool.forEach(t => {
        let div = document.createElement('div');
        div.className = 'card';
        div.innerHTML = `<h3>${t.name}</h3><p>${t.desc}</p>`;
        div.onclick = () => {
            if(div.classList.contains('selected')) {
                div.classList.remove('selected');
                div.style.borderColor = '#444';
            } else {
                if(document.querySelectorAll('.card.selected').length < 2) {
                    div.classList.add('selected');
                    div.style.borderColor = 'var(--highlight)';
                }
            }
        };
        div.traitData = t; // attach data
        container.appendChild(div);
    });
}

function confirmStart() {
    let selected = document.querySelectorAll('.card.selected');
    if(selected.length !== 2) return alert("è«‹é¸æ“‡å…©å€‹å¤©è³¦ï¼");
    
    state.name = document.getElementById('player-name').value || "éŸ­èœ";
    
    // æ‡‰ç”¨å¤©è³¦
    let startMoney = 0;
    let hasLoan = false; // é»˜èªæ˜¯å¦è² å‚µé–‹å±€é‚è¼¯éœ€çµ±ä¸€
    
    // åŸºç¤è¨­å®šï¼šå¦‚æœæ²’é¸ç‰¹æ®Šé–‹å±€ï¼Œé»˜èªæ‰“å·¥æ¨¡å¼
    // é€™è£¡ç°¡åŒ–ï¼šå¦‚æœæœ‰é¸åŠ éŒ¢çš„å¤©è³¦å°±ç”¨å¤©è³¦ï¼Œå¦å‰‡é»˜èªç‚ºã€Œæ‰“å·¥æ¨¡å¼ã€ï¼ˆ0é–‹å±€ï¼‰æˆ–ã€Œå­¸è²¸æ¨¡å¼ã€ï¼ˆç©å®¶é€™è£¡å¯é¸å—ï¼Ÿç…§èˆŠç‰ˆé‚è¼¯ç°¡åŒ–ï¼‰
    // ç‚ºäº†æµæš¢ï¼Œæˆ‘å€‘è¨­å®šï¼šå¦‚æœæœ‰éŒ¢çš„å¤©è³¦ï¼Œç–ŠåŠ ï¼›å¦å‰‡åŸºç¤æ˜¯ 0 (æ‰“å·¥) æˆ– 20è¬(å€Ÿè²¸)ã€‚
    // è®“æˆ‘å€‘è¨­å®šä¸€å€‹åŸºç¤å°è©±æ¡†äºŒé¸ä¸€ï¼Œæˆ–è€…ç›´æ¥åœ¨é€™è£¡è™•ç†ã€‚
    // *ç°¡åŒ–ï¼š* æ²’é¸è³‡é‡‘å¤©è³¦çš„ï¼Œé»˜èªæ˜¯ $0 æ‰“å·¥é–‹å±€ã€‚
    
    selected.forEach(el => {
        let t = el.traitData;
        if(t.money) startMoney += t.money;
        if(t.loan !== undefined) hasLoan = t.loan; // true or false override
        if(t.stressLock) state.stressLocked = true;
        if(t.luck) state.luck = t.luck;
        if(t.items) t.items.forEach(i => gainItem(i));
        if(t.salaryMult) state.salary *= t.salaryMult;
        if(t.stress) state.stress = t.stress;
        
        if(t.easterEgg) {
            if(Math.random() > 0.5) {
                alert("ä½ çˆ¸çœŸçš„æ˜¯ Elonï¼ç›´æ¥è½‰å¸³ 1000 å„„ï¼");
                state.money = 100000000000;
                checkEnd();
                return;
            } else {
                alert("ä½ çˆ¸æ˜¯å‡çš„ï¼è¢«é¨™å…‰ç©è“„ï¼Œä½†çœ‹ç ´ç´…å¡µé‹æ°£çˆ†æ£šï¼");
                startMoney = 0;
                state.luck = 200;
            }
        }
    });

    // å¦‚æœæ²’æœ‰æ˜ç¢ºè¨­å®šè² å‚µ/è³‡é‡‘ï¼Œæˆ‘å€‘çµ¦ä¸€å€‹æ¨™æº–é–‹å±€é¸æ“‡å—ï¼Ÿ
    // ç‚ºäº†å¿«ç¯€å¥ï¼Œå¦‚æœå¤©è³¦æ²’çµ¦éŒ¢ï¼Œé»˜èªç‚ºè² å‚µé–‹å±€å¢åŠ æŒ‘æˆ°æ€§
    if(startMoney === 0) {
        let userChoseLoan = confirm("é–‹å±€é¸æ“‡ï¼š\n[ç¢ºå®š] å€Ÿè²¸ $200,000 (æ¯æœˆé‚„ $5000)\n[å–æ¶ˆ] æ‰“å·¥ (åˆå§‹ $0ï¼Œç„¡å‚µ)");
        if(userChoseLoan) {
            startMoney = 200000;
            state.loan = CONFIG.LOAN_REPAY;
        } else {
            startMoney = 0;
            state.loan = 0;
        }
    } else {
        // å¦‚æœå¤©è³¦çµ¦äº†éŒ¢ï¼Œæª¢æŸ¥æœ‰æ²’æœ‰èªªè¦é‚„è²¸
        if(hasLoan) state.loan = CONFIG.LOAN_REPAY;
    }

    state.money = startMoney;
    
    document.getElementById('start-screen').classList.add('hidden');
    document.getElementById('game-container').classList.remove('hidden');
    updateUI();
    nextDay();
}

/* --- éŠæˆ²å¾ªç’° --- */

function nextDay() {
    state.day++;
    
    // è™•ç†è¢«å‹•æŠ€èƒ½
    if(hasSkill("time_manage") && Math.random() < 0.1) {
        state.day--; // æ™‚é–“å€’æµï¼Œä¸æ¶ˆè€—å¤©æ•¸
        log("ã€æ™‚é–“ç®¡ç†ã€‘è§¸ç™¼ï¼Œä»Šæ—¥ä¸è¨ˆå…¥æ™‚é–“æµé€ã€‚");
    }

    // æœˆçµ
    if(state.day % 30 === 0) {
        monthlyProcess();
    } else {
        generateMarket();
        updateUI();
        
        // éš¨æ©Ÿå¥‡é‡
        if(Math.random() < 0.15) triggerRandomEvent();
    }
}

function monthlyProcess() {
    // æ‰£è²»/ç™¼è–ª
    let cost = state.livingCost;
    if(state.money < 50000 && hasSkill("beggar_sect")) {
        let alms = Math.floor(Math.random() * 5000) + 2000;
        state.money += alms;
        log(`ã€ä¸å¹«å¿ƒæ³•ã€‘ç²å¾—å–„æ¬¾ +$${alms}`);
    }

    let salary = state.salary;
    if(hasSkill("salary_boost")) salary *= 1.5;

    state.money -= cost;
    state.money -= state.loan;
    state.money += salary;
    
    // å£“åŠ›å›å¾©
    if(hasSkill("auto_stress")) {
        state.stress = Math.floor(state.stress * 0.7);
        log("ã€å†°å¿ƒè¨£ã€‘é‹è½‰ï¼Œå£“åŠ›å¤§å¹…ä¸‹é™ã€‚");
    }

    log(`=== æœˆçµ === ç”Ÿæ´»è²» -$${cost} | é‚„è²¸ -$${state.loan} | å·¥è³‡ +$${salary}`);
    
    checkEnd();
    
    // è§¸ç™¼ Roguelike å‡ç´š
    triggerLevelUp();
}

function triggerLevelUp() {
    // éš¨æ©ŸæŠ½å–3å€‹æœªæ“æœ‰çš„æŠ€èƒ½
    let available = SKILLS_DB.filter(s => !state.skills.includes(s.id));
    if(available.length === 0) {
        log("ä½ å·²å­¸æœƒæ‰€æœ‰åŠŸæ³•ï¼Œä¿®ç‚ºç²¾é€²ï¼(ç²å¾—å°‘é‡è³‡é‡‘)");
        state.money += 50000;
        updateUI();
        generateMarket();
        return;
    }
    
    let choices = available.sort(()=>0.5-Math.random()).slice(0,3);
    let container = document.getElementById('upgrade-choices');
    container.innerHTML = "";
    
    choices.forEach(s => {
        let div = document.createElement('div');
        div.className = 'card';
        div.innerHTML = `<h3 style="color:var(--rare)">${s.name}</h3><p>${s.desc}</p>`;
        div.onclick = () => {
            state.skills.push(s.id);
            if(s.type === 'insight') state.insightLevel = Math.max(state.insightLevel, s.val);
            log(`ç¿’å¾—åŠŸæ³•ï¼š<span style="color:var(--rare)">${s.name}</span>`);
            document.getElementById('levelup-screen').classList.add('hidden');
            generateMarket();
            updateUI();
        };
        container.appendChild(div);
    });
    
    document.getElementById('levelup-screen').classList.remove('hidden');
}

/* --- å¸‚å ´ç³»çµ± --- */

function generateMarket() {
    const name = STOCK_NAMES[rand(0, STOCK_NAMES.length-1)] + STOCK_SUFFIX[rand(0, STOCK_SUFFIX.length-1)];
    
    // åŸºç¤è¶¨å‹¢
    let t5 = rand(-15, 15);
    let t30 = rand(-40, 40);
    let t365 = rand(-100, 200);
    
    // æ–°è
    let newsList = [
        {txt: "CEO æ¶‰å«Œæ´—éŒ¢è¢«æ•", val: -20},
        {txt: "å» æˆ¿ç™¼ç”Ÿåš´é‡ç«ç½", val: -15},
        {txt: "ä¸»è¦è‚¡æ±æ¸›æŒå¥—ç¾", val: -10},
        {txt: "ç”¢å“éŠ·é‡ç•¥ä½æ–¼é æœŸ", val: -5},
        {txt: "å¸‚å ´åæ‡‰å¹³å¹³", val: 0},
        {txt: "ç™¼å¸ƒå¹´åº¦æ——è‰¦ç”¢å“", val: 5},
        {txt: "ç²å¾—åœ‹å®¶ç´šå°ˆåˆ©", val: 10},
        {txt: "è¢«ç§‘æŠ€å·¨é ­æº¢åƒ¹æ”¶è³¼", val: 15},
        {txt: "åˆ©æ½¤åŒæ¯”å¢é•· 500%", val: 25}
    ];
    let news = newsList[rand(0, newsList.length-1)];
    
    // å¼·åˆ¶å¹²é  (ç‰©å“æ•ˆæœ)
    if(state.forceTrend === 1) news = {txt: "é¦¬æ–¯å…‹ç™¼æ¨å¤§åŠ›æ”¯æŒ (å¼·åˆ¶åˆ©å¥½)", val: 30};
    if(state.forceTrend === -1) news = {txt: "åšç©ºæ©Ÿæ§‹ç™¼å¸ƒæ¯€æ»…æ€§å ±å‘Š (å¼·åˆ¶åˆ©ç©º)", val: -30};
    
    // å¯¦éš›æ¼²è·Œæ¦‚ç‡è¨ˆç®—
    // åŸºç¤ 50% + æ–°èå½±éŸ¿ + é‹æ°£ä¿®æ­£ + è¶¨å‹¢æ…£æ€§
    let baseWin = 50 + news.val + (state.luck - 50) * 0.2;
    if(t5 > 5) baseWin += 5; // è¿½æ¼²
    if(t5 < -5) baseWin -= 5; // æ®ºè·Œ
    
    // é™åˆ¶ç¯„åœ
    baseWin = Math.min(90, Math.max(10, baseWin));
    
    state.currentStock = {
        name: name,
        t5: t5, t30: t30, t365: t365,
        news: news.txt,
        winRate: baseWin, // çœŸå¯¦åšå¤šå‹ç‡
        volatility: rand(5, 40) // æ³¢å‹•å¹…åº¦ %
    };
    
    state.forceTrend = 0; // é‡ç½®å¼·åˆ¶æ•ˆæœ
    
    renderMarket();
}

function renderMarket() {
    let s = state.currentStock;
    document.getElementById('stock-name').innerText = s.name;
    document.getElementById('news-text').innerText = s.news;
    document.getElementById('news-text').style.borderLeftColor = s.winRate > 50 ? 'var(--red)' : 'var(--green)';
    
    const fmt = (v) => `<span class="${v>=0?'profit':'loss'}">${v>=0?'+':''}${v}%</span>`;
    document.getElementById('t-5').innerHTML = fmt(s.t5);
    document.getElementById('t-30').innerHTML = fmt(s.t30);
    document.getElementById('t-365').innerHTML = fmt(s.t365);
    
    // æ´å¯ŸåŠ›é¡¯ç¤º
    let rateDisp = "???";
    if(state.insightLevel >= 1) {
        // Lv1: æ¨¡ç³Š (é«˜æ–¼50é¡¯ç¤º"çœ‹æ¼²", ä½æ–¼é¡¯ç¤º"çœ‹è·Œ")
        rateDisp = s.winRate > 55 ? "çœ‹æ¼²" : (s.winRate < 45 ? "çœ‹è·Œ" : "éœ‡ç›ª");
    }
    if(state.insightLevel >= 2) {
        // Lv2: å…·é«”æ•¸å­—
        rateDisp = Math.floor(s.winRate) + "%";
    }
    document.getElementById('insight-display').innerText = "å‹ç‡: " + rateDisp;
    
    // æŒ‰éˆ•ä¸Šçš„å‹ç‡è¼”åŠ© (å¦‚æœæœ‰Lv2)
    if(state.insightLevel >= 2) {
        document.getElementById('rate-long').innerText = Math.floor(s.winRate) + "%";
        document.getElementById('rate-short').innerText = Math.floor(100 - s.winRate) + "%";
    } else {
        document.getElementById('rate-long').innerText = "--%";
        document.getElementById('rate-short').innerText = "--%";
    }
}

/* --- äº¤æ˜“æ“ä½œ --- */

let posMultipliers = [0.05, 0.20, 0.50, 1.00];
function updatePosDisplay() {
    let val = document.getElementById('pos-slider').value;
    let pct = posMultipliers[val-1] * 100;
    document.getElementById('pos-display').innerText = pct + "%";
}

function trade(type) {
    // ç‹€æ…‹æª¢æŸ¥
    if(checkMentalState()) return; // å¤±æ§æª¢æ¸¬

    if(type === 'skip') {
        log("ä½ é¸æ“‡è§€æœ›ï¼Œå–äº†ä¸€æ¯å’–å•¡ã€‚ (å¿«æ¨‚+5, å£“åŠ›-5)");
        changeStats(-5, 5);
        nextDay();
        return;
    }

    let posIdx = document.getElementById('pos-slider').value - 1;
    let pct = posMultipliers[posIdx];
    let bet = state.money * pct;
    if(bet < 100 && state.money > 0) bet = state.money; // é¤˜é¡ä¸è¶³å¼·åˆ¶ All in
    if(state.money <= 0) return alert("ä½ å·²ç¶“æ²’éŒ¢äº†ï¼");

    let stock = state.currentStock;
    let isWin = false;
    
    // åˆ¤å®šè¼¸è´
    if(state.nextTradeWin) {
        isWin = true;
        state.nextTradeWin = false;
        log("ã€å…§å¹•æ‰‹æ©Ÿã€‘ç”Ÿæ•ˆï¼æœ¬æ¬¡äº¤æ˜“å¼·åˆ¶ç²åˆ©ï¼");
    } else {
        let roll = Math.random() * 100;
        if(type === 'long') isWin = roll < stock.winRate;
        else isWin = roll >= stock.winRate; // åšç©º
    }

    // è¨ˆç®—é‡‘é¡
    let move = rand(1, stock.volatility); // å¯¦éš›æ³¢å‹•
    let pnl = 0;
    
    if(isWin) {
        let profitMult = 1;
        if(hasSkill("profit_boost")) profitMult = 1.1;
        pnl = bet * (move / 100) * profitMult;
        state.money += pnl;
        changeStats(-10, 5); // è´éŒ¢æ¸›å£“
        log(`åš${type==='long'?'å¤š':'ç©º'} ${stock.name} <span class="profit">ç›ˆåˆ© $${Math.floor(pnl)} (+${move}%)</span>`);
    } else {
        pnl = bet * (move / 100);
        // é‘½çŸ³æ‰‹æ¸›å‚·
        if(hasSkill("diamond_hand")) pnl *= 0.5;
        
        state.money -= pnl;
        changeStats(15, -10); // è¼¸éŒ¢åŠ å£“
        log(`åš${type==='long'?'å¤š':'ç©º'} ${stock.name} <span class="loss">è™§æ $${Math.floor(pnl)} (-${move}%)</span>`);
    }
    
    checkEnd();
    nextDay();
}

function checkMentalState() {
    let isCrazy = false;
    if(!state.stressLocked && state.stress >= 90) isCrazy = true;
    if(state.happy <= 10) isCrazy = true;
    
    if(isCrazy) {
        log("<span style='color:var(--red)'>ã€èµ°ç«å…¥é­”ã€‘ä½ å¿ƒæ…‹å´©äº†ï¼Œç„¡æ³•æ§åˆ¶è‡ªå·±çš„æ‰‹ï¼</span>");
        let randomType = Math.random()>0.5 ? 'long' : 'short';
        // å¼·åˆ¶éš¨æ©Ÿæ“ä½œ
        setTimeout(() => {
            let stock = state.currentStock;
            let roll = Math.random() * 100;
            let isWin = roll < 50; // ç´”é‹æ°£
            let move = rand(10, 50); // ç˜‹ç‹‚æ³¢å‹•
            let bet = state.money * 0.5; // å¼·åˆ¶åŠå€‰
            
            if(isWin) {
                state.money += bet * (move/100);
                log(`(å¤±æ§æ“ä½œ) å±…ç„¶è’™å°äº†ï¼ç›ˆåˆ© $${Math.floor(bet*move/100)}`);
                changeStats(-20, 20);
            } else {
                state.money -= bet * (move/100);
                log(`(å¤±æ§æ“ä½œ) æ…˜é­è¡€æ´—ï¼è™§æ $${Math.floor(bet*move/100)}`);
                changeStats(20, -20);
            }
            nextDay();
        }, 500);
        return true;
    }
    return false;
}

/* --- ç‰©å“èˆ‡äº‹ä»¶ç³»çµ± --- */

function triggerRandomEvent() {
    const events = [
        {
            text: "è·¯é‚Šæ’¿åˆ°ä¸€å€‹éºå¤±çš„éŒ¢åŒ…...",
            opts: [
                {t: "æ“šç‚ºå·±æœ‰", f: ()=>{ state.money+=2000; state.luck-=5; return "ç²å¾—$2000ï¼Œäººå“æ•—å£ã€‚"; }},
                {t: "å°‹æ‰¾å¤±ä¸»", f: ()=>{ state.luck+=10; state.happy+=5; return "å¤±ä¸»æ„Ÿè¬ä½ ï¼Œé‹æ°£ä¸Šå‡ã€‚"; }}
            ]
        },
        {
            text: "ç¥ç¥•è€ä¹ä¸å‘ä½ å…œå”®ç¥ç‰©...",
            opts: [
                {t: "è³¼è²·ç›²ç›’($5000)", f: ()=>{ 
                    if(state.money<5000) return "éŒ¢ä¸å¤ ";
                    state.money-=5000;
                    if(Math.random()<0.5) { gainItem("stress_pill"); return "ç²å¾—é€é™ä¸¹ï¼"; }
                    else { return "ç›’å­æ˜¯ç©ºçš„ï¼Œè¢«é¨™äº†ã€‚"; }
                }},
                {t: "ç„¡è¦–", f: ()=> "ä½ éŒ¯éäº†æ©Ÿç·£ã€‚"}
            ]
        },
        {
            text: "ç¶²ä¸Šçœ‹åˆ°ä¸€å€‹ç‚’è‚¡å¤§å¸«èª²ç¨‹...",
            opts: [
                {t: "å ±å($10000)", f: ()=>{
                    if(state.money<10000) return "éŒ¢ä¸å¤ ";
                    state.money-=10000;
                    state.insightLevel = Math.max(state.insightLevel, 1);
                    return "å­¸åˆ°äº†ä¸€äº›çš®æ¯›(æ´å¯ŸåŠ›æå‡)ã€‚";
                }},
                {t: "é‚£æ˜¯è©é¨™", f: ()=>{ state.stress-=5; return "å¿ƒå¦‚æ­¢æ°´ã€‚"; }}
            ]
        }
    ];
    
    let evt = events[rand(0, events.length-1)];
    // ç‚ºäº†ç°¡å–®ï¼Œäº‹ä»¶ç›´æ¥å½ˆçª—æˆ–å¯«å…¥Logï¼Œé€™è£¡ç°¡åŒ–ç‚º Log + è‡ªå‹•é¸æ“‡(å¦‚æœä¸åšè¤‡é›œå½ˆçª—)
    // ç‚ºäº†æ›´å¥½é«”é©—ï¼Œåšä¸€å€‹ç°¡å–®çš„ `confirm` æˆ–è€…ç›´æ¥åœ¨ log å€é¡¯ç¤ºäº’å‹•æŒ‰éˆ•
    // é‘‘æ–¼ä»£ç¢¼é‡ï¼Œæˆ‘å€‘é€™è£¡ç”¨ Log é¡¯ç¤ºäº‹ä»¶ç™¼ç”Ÿï¼Œä¸¦éš¨æ©Ÿçµ¦äºˆçµæœï¼Œæˆ–è€…ç²å¾—ç‰©å“
    
    // æ”¹ç‚ºç›´æ¥æ‰è½ç‰©å“æˆ–ç‹€æ…‹è®ŠåŒ–
    let r = Math.random();
    if(r < 0.3) {
        gainItem("stress_pill");
        log("ã€å¥‡é‡ã€‘ä½ åœ¨èˆŠæ›¸æ”¤ç™¼ç¾äº†å¤æ–¹ã€Œé€é™ä¸¹ã€ã€‚");
    } else if (r < 0.5) {
        state.stress += 10;
        log("ã€çªç™¼ã€‘é›»è…¦å£äº†ï¼Œä¿®ç†èŠ±äº†ä¸€ç­†éŒ¢ï¼Œå£“åŠ›å±±å¤§ã€‚");
    } else if (r < 0.6) {
        if(Math.random() > 0.5) { gainItem("elon_tweet"); log("ã€å¥‡é‡ã€‘ä½ é»‘é€²äº†é¦¬æ–¯å…‹çš„æ¨ç‰¹å¸³è™Ÿï¼(ç²å¾—ç¥å™¨)"); }
        else { gainItem("short_report"); log("ã€å¥‡é‡ã€‘ä½ æ’¿åˆ°ä¸€ä»½æ©Ÿæ§‹æœªç™¼å¸ƒçš„åšç©ºå ±å‘Šï¼(ç²å¾—ç¥å™¨)"); }
    }
}

function gainItem(id) {
    state.inventory.push(id);
    renderInventory();
}

function renderInventory() {
    let bar = document.getElementById('inventory-bar');
    bar.innerHTML = "";
    
    // çµ±è¨ˆæ•¸é‡
    let counts = {};
    state.inventory.forEach(i => counts[i] = (counts[i]||0)+1);
    
    Object.keys(counts).forEach(id => {
        let item = ITEM_DB[id];
        let div = document.createElement('div');
        div.className = 'item-slot';
        div.innerHTML = `${item.icon}<span class="item-count">${counts[id]}</span>`;
        div.style.borderColor = item.rarity === 'legendary' ? var(--legendary) : (item.rarity==='rare'?var(--rare):'#555');
        div.onclick = () => showItemModal(id);
        bar.appendChild(div);
    });
}

let selectedItemId = null;
function showItemModal(id) {
    selectedItemId = id;
    let item = ITEM_DB[id];
    document.getElementById('modal-item-name').innerText = item.name;
    document.getElementById('modal-item-desc').innerText = item.desc;
    document.getElementById('item-modal').classList.remove('hidden');
}

function closeModal() {
    document.getElementById('item-modal').classList.add('hidden');
}

function useItemConfirm() {
    if(!selectedItemId) return;
    
    // åŸ·è¡Œæ•ˆæœ
    let used = true;
    if(selectedItemId === "stress_pill") {
        state.stress = 0; state.happy = 100;
        log("æœç”¨é€é™ä¸¹ï¼Œé€šé«”èˆ’æš¢ï¼");
    } else if(selectedItemId === "insider_phone") {
        state.nextTradeWin = true;
        log("ä½¿ç”¨äº†å…§å¹•æ‰‹æ©Ÿï¼Œä¸‹æ¬¡äº¤æ˜“å¿…å‹ã€‚");
    } else if(selectedItemId === "elon_tweet") {
        state.forceTrend = 1;
        log("ç™¼å‹•ç¥å™¨ï¼šé¦¬æ–¯å…‹æ¨æ–‡ï¼æ˜æ—¥è‚¡å¸‚å°‡æš´æ¼²ã€‚");
        generateMarket(); // ç«‹å³åˆ·æ–°ç•¶å‰å¸‚å ´é¡¯ç¤ºæ•ˆæœ
    } else if(selectedItemId === "short_report") {
        state.forceTrend = -1;
        log("ç™¼å‹•ç¥å™¨ï¼šåšç©ºå ±å‘Šï¼æ˜æ—¥è‚¡å¸‚å°‡æš´è·Œã€‚");
        generateMarket();
    } else if(selectedItemId === "lucky_charm") {
        state.luck += 5;
        log("ä½©æˆ´è½‰é‹ç¬¦ï¼Œé‹æ°£æ°¸ä¹…æå‡ã€‚");
    } else if(selectedItemId === "bailout") {
        if(state.money > 10000) {
            alert("ä½ ç¾åœ¨é‚„ä¸å¤ çª®ï¼Œå¯Œå©†çœ‹ä¸ä¸Šä½ ã€‚");
            used = false;
        } else {
            state.money += 50000;
            log("å¯Œå©†å«æ·šè³‡åŠ©äº†ä½  $50,000ã€‚");
        }
    }
    
    if(used) {
        // ç§»é™¤ä¸€å€‹ç‰©å“
        let idx = state.inventory.indexOf(selectedItemId);
        if(idx > -1) state.inventory.splice(idx, 1);
        renderInventory();
        updateUI();
        closeModal();
    }
}

/* --- è¼”åŠ©å‡½æ•¸ --- */

function changeStats(s, h) {
    if(!state.stressLocked) state.stress = Math.max(0, Math.min(100, state.stress + s));
    state.happy = Math.max(0, Math.min(100, state.happy + h));
}

function updateUI() {
    document.getElementById('val-money').innerText = "$" + Math.floor(state.money).toLocaleString();
    document.getElementById('val-day').innerText = state.day;
    document.getElementById('val-stress').innerText = state.stress;
    document.getElementById('val-happy').innerText = state.happy;
    document.getElementById('val-luck').innerText = state.luck;
    
    // ä¿®ç‚ºé¡¯ç¤º
    let titles = ["ç·´æ°£", "ç¯‰åŸº", "é‡‘ä¸¹", "å…ƒå¬°", "åŒ–ç¥", "å¤§ä¹˜", "æ¸¡åŠ«"];
    let lv = Math.min(titles.length-1, Math.floor(state.day / 60)); // æ¯2å€‹æœˆå‡ä¸€éšç¨±è™Ÿ
    document.getElementById('val-stage').innerText = titles[lv] + "æœŸ";
}

function checkEnd() {
    if(state.money >= CONFIG.GOAL) {
        endGame("é£›å‡æˆåŠŸ", "ä½ æˆ°å‹äº†è³‡æœ¬ï¼Œé”æˆè²¡å¯Œè‡ªç”±ï¼Œç ´ç¢è™›ç©ºè€Œå»ï¼");
    }
    else if(state.money < -50000) { // å…è¨±è² å‚µä¸€é»é»ï¼Œå¤ªä½æ‰æ­»
        endGame("é“æ¶ˆèº«æ®", "ä½ å·²è³‡ä¸æŠµå‚µï¼Œè¢«é«˜åˆ©è²¸æŠ“å»æŒ–ç¤¦äº†ã€‚");
    }
}

function endGame(title, reason) {
    document.getElementById('end-title').innerText = title;
    document.getElementById('end-reason').innerText = reason;
    document.getElementById('end-money').innerText = "$" + Math.floor(state.money).toLocaleString();
    document.getElementById('end-screen').classList.remove('hidden');
}

function log(msg) {
    let div = document.createElement('div');
    div.className = 'log-entry';
    div.innerHTML = `<span class="log-date">Day ${state.day}</span> ${msg}`;
    let area = document.getElementById('log-area');
    area.insertBefore(div, area.firstChild); // æ–°æ¶ˆæ¯åœ¨æœ€ä¸Š
}

function hasSkill(id) {
    return state.skills.some(s => SKILLS_DB.find(db => db.id === s)?.effect === id);
}

function rand(min, max) {
    return Math.floor(Math.random() * (max - min + 1)) + min;
}

// Start
init();

</script>
</body>
</html>

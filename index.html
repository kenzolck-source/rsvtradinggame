<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é‡‘èä¿ å®¢è¡Œï¼šæœŸè²¨ä¿®ä»™éŒ„</title>
    <style>
        :root {
            --bg-color: #1a1a1a;
            --text-color: #e0e0e0;
            --highlight: #f1c40f;
            --red: #e74c3c; /* è·Œ/è™§æ */
            --green: #2ecc71; /* å‡/ç›ˆåˆ© - ä¾ç…§åœ‹éš›æ…£ä¾‹ï¼Œè‹¥è¦ä¸­åœ‹æ…£ä¾‹å¯äº’æ› */
            --panel-bg: #2c3e50;
            --btn-bg: #34495e;
            --btn-hover: #2980b9;
        }
        
        /* ä¸­åœ‹è‚¡å¸‚æ…£ä¾‹ï¼šç´…æ¼²ç¶ è·Œ */
        .up { color: #e74c3c; font-weight: bold; }
        .down { color: #2ecc71; font-weight: bold; }

        body {
            font-family: 'Microsoft JhengHei', 'Courier New', monospace;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            height: 100vh;
            overflow: hidden;
            user-select: none;
        }

        #game-container {
            width: 100%;
            max-width: 600px;
            background-color: #222;
            display: flex;
            flex-direction: column;
            border-left: 1px solid #444;
            border-right: 1px solid #444;
            position: relative;
        }

        /* Header Stats */
        #header {
            padding: 10px;
            background-color: var(--panel-bg);
            border-bottom: 2px solid #000;
            font-size: 14px;
        }
        
        .stat-row { display: flex; justify-content: space-between; margin-bottom: 5px; }
        .stat-box { width: 48%; }
        .progress-bar { width: 100%; height: 8px; background: #555; margin-top: 2px; }
        .progress-fill { height: 100%; transition: width 0.3s; }

        /* Main Log Area */
        #log-area {
            flex-grow: 1;
            padding: 15px;
            overflow-y: auto;
            font-size: 15px;
            line-height: 1.6;
            background: #1e1e1e;
        }
        .log-entry { margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px dashed #333; }
        .log-date { color: #888; font-size: 12px; }
        .event-text { color: var(--highlight); }
        .danger-text { color: #e74c3c; }

        /* Market Panel */
        #market-panel {
            background-color: var(--panel-bg);
            padding: 10px;
            border-top: 2px solid #000;
        }
        .stock-info { 
            background: #111; padding: 10px; margin-bottom: 10px; border-radius: 5px; 
            border: 1px solid #555;
        }
        .stock-title { font-size: 18px; color: var(--highlight); margin-bottom: 5px; }
        .trend-info { display: flex; justify-content: space-between; font-size: 12px; color: #aaa; }
        .news-flash { margin-top: 5px; font-style: italic; color: #fff; font-size: 13px; }

        /* Controls */
        #controls {
            padding: 10px;
            background-color: #111;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 5px;
        }

        button {
            background-color: var(--btn-bg);
            color: white;
            border: none;
            padding: 10px;
            cursor: pointer;
            border-radius: 4px;
            font-family: inherit;
        }
        button:hover { background-color: var(--btn-hover); }
        button:disabled { background-color: #555; cursor: not-allowed; opacity: 0.6; }
        
        .btn-long { background-color: #e74c3c; } /* ç´…è‰²åšå¤š */
        .btn-short { background-color: #2ecc71; } /* ç¶ è‰²åšç©º */
        .btn-skip { background-color: #95a5a6; grid-column: span 4; margin-top: 5px;}
        
        .position-selector { grid-column: span 4; display: flex; gap: 5px; margin-bottom: 5px; }
        .pos-btn { flex: 1; font-size: 12px; }
        .pos-btn.active { border: 2px solid var(--highlight); }

        /* Modal / Overlays */
        .overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            padding: 20px;
            box-sizing: border-box;
            text-align: center;
        }
        .hidden { display: none !important; }
        
        .trait-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 100%; margin: 20px 0; }
        .trait-card { 
            background: #333; padding: 10px; cursor: pointer; border: 1px solid #555; font-size: 13px;
        }
        .trait-card.selected { border-color: var(--highlight); background: #444; }

        .choice-btn { width: 100%; margin: 5px 0; padding: 15px; text-align: left; background: #333; }

        /* Utility */
        h1, h2, h3 { margin: 0 0 10px 0; }
        .blink { animation: blinker 1s linear infinite; }
        @keyframes blinker { 50% { opacity: 0; } }
    </style>
</head>
<body>

    <!-- å•Ÿå‹•ä»‹é¢ / ç‰¹æ€§é¸æ“‡ -->
    <div id="start-screen" class="overlay">
        <h1>é‡‘èä¿ å®¢ä¿®ä»™éŒ„</h1>
        <p>18æ­²ï¼Œå‘½é‹çš„é½’è¼ªé–‹å§‹è½‰å‹•...</p>
        <input type="text" id="player-name" placeholder="è¼¸å…¥ä½ çš„åå­—" style="padding:10px; font-size:16px; margin-bottom:10px;">
        <p>è«‹é¸æ“‡å…©å€‹å¤©è³¦ç‰¹æ€§ï¼š</p>
        <div id="trait-selection" class="trait-grid"></div>
        <button onclick="confirmStart()" style="width:100%; padding: 15px; font-size: 18px;">é–‹å§‹äººç”Ÿ</button>
    </div>

    <!-- é–‹å±€é¸æ“‡ -->
    <div id="career-choice" class="overlay hidden">
        <h2>äººç”Ÿçš„å²”è·¯å£</h2>
        <p>å‰›æ»¿18æ­²ï¼Œä½ é¢è‡¨é‡å¤§æŠ‰æ“‡ï¼š</p>
        <button onclick="startGame(true)" class="choice-btn">
            <strong>å€Ÿè²¸æ¢­å“ˆ (All In)</strong><br>
            å€Ÿç›¡å­¸è²¸ 20è¬èµ·å§‹è³‡é‡‘ï¼Œæ¯æœˆéœ€é‚„æ¬¾ $5,000ã€‚
        </button>
        <button onclick="startGame(false)" class="choice-btn">
            <strong>æ‰“å·¥ç©ç´¯ (ç©©å¥)</strong><br>
            èµ·å§‹è³‡é‡‘ 0ï¼Œæ¯æœˆæ‰“å·¥æ”¶å…¥ $15,000ã€‚
        </button>
        <p style="margin-top:20px; font-size:12px; color:#888;">*ç„¡è«–é¸æ“‡å“ªç¨®ï¼Œæ¯æœˆåŸºç¤ç”Ÿæ´»è²»æ‰£é™¤ $10,000</p>
    </div>

    <!-- éŠæˆ²ä¸»ä»‹é¢ -->
    <div id="game-container" class="hidden">
        <div id="header">
            <div class="stat-row">
                <div class="stat-box">ğŸ’° è³‡é‡‘: <span id="val-money">0</span></div>
                <div class="stat-box">ğŸ“… æ—¥æœŸ: <span id="val-date">ç¬¬ 1 å¤©</span> (18æ­²)</div>
            </div>
            <div class="stat-row">
                <div class="stat-box">
                    ğŸ˜– å£“åŠ›: <span id="val-stress">0</span>/100
                    <div class="progress-bar"><div id="bar-stress" class="progress-fill" style="width:0%; background:#e74c3c"></div></div>
                </div>
                <div class="stat-box">
                    ğŸ˜„ å¿«æ¨‚: <span id="val-happy">100</span>/100
                    <div class="progress-bar"><div id="bar-happy" class="progress-fill" style="width:100%; background:#f1c40f"></div></div>
                </div>
            </div>
            <div class="stat-row" style="font-size:12px; color:#aaa;">
                <span>ğŸ€ é‹æ°£: <span id="val-luck">50</span></span>
                <span>ğŸ”¥ ç‹€æ…‹: <span id="val-status">æ­£å¸¸</span></span>
            </div>
        </div>

        <div id="log-area">
            <div class="log-entry">æ­¡è¿ä¾†åˆ°é‡‘èå¸‚å ´ï¼Œç›®æ¨™æ˜¯è³ºå– <strong>ä¸€å„„ ($100,000,000)</strong>ã€‚</div>
        </div>

        <div id="market-panel">
            <div class="stock-info">
                <div class="stock-title" id="stock-name">---</div>
                <div class="trend-info">
                    <span>5æ—¥: <span id="trend-5">--</span></span>
                    <span>1æœˆ: <span id="trend-30">--</span></span>
                    <span>1å¹´: <span id="trend-365">--</span></span>
                </div>
                <div class="news-flash" id="stock-news">ä»Šæ—¥ä¼‘å¸‚</div>
            </div>
        </div>

        <div id="controls">
            <div class="position-selector">
                <button class="pos-btn" onclick="setPos(0.05)">5%</button>
                <button class="pos-btn active" onclick="setPos(0.2)">20%</button>
                <button class="pos-btn" onclick="setPos(0.5)">50%</button>
                <button class="pos-btn" onclick="setPos(1.0)">100%</button>
            </div>
            <button class="btn-long" onclick="trade('long')">åšå¤š (Long)</button>
            <button class="btn-short" onclick="trade('short')">åšç©º (Short)</button>
            <button class="btn-long" onclick="trade('long')" style="visibility:hidden">X</button> <!-- Spacer -->
            <button class="btn-short" onclick="trade('short')" style="visibility:hidden">X</button> <!-- Spacer -->
            <button class="btn-skip" onclick="trade('skip')">ä»€éº¼éƒ½ä¸åš (ä¼‘æ¯)</button>
        </div>
    </div>

    <!-- å¥‡é‡ä»‹é¢ -->
    <div id="event-screen" class="overlay hidden">
        <h2 id="event-title">å¥‡é‡</h2>
        <p id="event-desc">ç™¼ç”Ÿäº†ä»€éº¼...</p>
        <div id="event-choices" style="width:100%"></div>
    </div>

    <!-- çµå±€ä»‹é¢ -->
    <div id="end-screen" class="overlay hidden">
        <h1 id="end-title">éŠæˆ²çµæŸ</h1>
        <p id="end-reason"></p>
        <p>æœ€çµ‚è³‡ç”¢: <span id="end-money"></span></p>
        <button onclick="location.reload()">é‡æ–°é–‹å§‹</button>
    </div>

<script>
/**
 * éŠæˆ²æ•¸æ“šèˆ‡å¸¸é‡
 */
const GAME_GOAL = 100000000;
const LIVING_COST_BASE = 10000;
const LOAN_REPAY = 5000;
const SALARY_BASE = 15000;

// éš¨æ©Ÿåç¨±åº«
const STOCK_PREFIXES = ["é¨°é›²", "è¯å¤", "æ·±è—", "æ¥µå…‰", "èèŸ»", "é‡å­", "å…ƒå®‡å®™", "æ™ºå‹", "æš´é¢¨", "ç†Šè²“"];
const STOCK_SUFFIXES = ["ç§‘æŠ€", "ç”Ÿç‰©", "é‡å·¥", "èƒ½æº", "äº’å¨›", "é†«è—¥", "åœ°ç”¢", "æ§è‚¡", "åœ‹éš›", "è‚¡ä»½"];
const NEWS_BAD = ["CEOæ²æ¬¾æ½›é€ƒ", "å» æˆ¿ç™¼ç”Ÿçˆ†ç‚¸", "æ¥­ç¸¾é ä½æ–¼é æœŸ", "é­åˆ°ç›£ç®¡èª¿æŸ¥", "ä¸»è¦å®¢æˆ¶é•ç´„", "ç”¢å“å‡ºç¾åš´é‡ç¼ºé™·"];
const NEWS_GOOD = ["ç²å¾—æ”¿åºœå·¨é¡è£œè²¼", "ç ”ç™¼å–å¾—é‡å¤§çªç ´", "æ¥­ç¸¾è¶…é æœŸå¢é•·", "å®£ä½ˆå¤§é¡å›è³¼", "è¢«å·¨é ­æº¢åƒ¹æ”¶è³¼", "ç”¢å“éŠ·é‡å‰µæ–°é«˜"];

// ç‰¹æ€§åº«
const TRAITS_POOL = [
    {id: 1, name: "çµ•å°ç†æ€§", desc: "ä½ æ˜¯è«å¾—æ„Ÿæƒ…çš„æ©Ÿå™¨ï¼Œå£“åŠ›æ°¸é ç‚º0ã€‚"},
    {id: 2, name: "æ¨‚è§€ä¸»ç¾©", desc: "æ„›ç¬‘çš„äººé‹æ°£ä¸æœƒå·®ï¼Œå¿«æ¨‚å€¼é–å®š100ã€‚"},
    {id: 3, name: "å°åº·ä¹‹å®¶", desc: "çˆ¶æ¯è³‡åŠ©ï¼Œèµ·å§‹è³‡é‡‘å¢åŠ  $100,000ã€‚"},
    {id: 4, name: "æˆ‘æœ‰å…¬å±‹", desc: "äººç”Ÿè´å®¶ï¼Œæ¯æœˆç”Ÿæ´»è²»é™è‡³ $1,000ã€‚"},
    {id: 5, name: "æ‰“å·¥è–é«”", desc: "è€é—†è³è­˜ï¼Œæ‰“å·¥å·¥è³‡æ¯å¹´ç¿»å€ã€‚"},
    {id: 6, name: "ç»ç’ƒå¿ƒ", desc: "å£“åŠ›å¢åŠ é€Ÿåº¦ç¿»å€ï¼Œä½†é‹æ°£åˆå§‹+20ã€‚"},
    {id: 7, name: "è³­å¾’", desc: "ç‚’è‚¡æ”¶ç›Šæ³¢å‹•ç‡æ¥µå¤§ã€‚"},
    {id: 8, name: "å¤©é¸ä¹‹å­", desc: "åˆå§‹é‹æ°£ 90ï¼Œå®¹æ˜“é‡åˆ°å¥½äº‹ã€‚"},
    {id: 9, name: "å€’éœ‰è›‹", desc: "åˆå§‹é‹æ°£ 10ï¼Œèµ°è·¯éƒ½æœƒè¸©å±ã€‚"},
    {id: 10, name: "å…§å¹•æ¶ˆæ¯", desc: "é–‹å±€ç›´æ¥ç²å¾—ä¸€æ¬¡ã€Œå¿…å‹ã€æ©Ÿæœƒã€‚"},
    {id: 11, name: "å¥åº·é”äºº", desc: "å£“åŠ›ä¸Šé™æå‡è‡³ 150ã€‚"},
    {id: 12, name: "æ®éœç„¡åº¦", desc: "ç”Ÿæ´»è²»å¢åŠ  50%ï¼Œä½†å¿«æ¨‚å›å¾©å¿«ã€‚"},
    {id: 13, name: "æ…é‡å‹‡è€…", desc: "åšå¤šåšç©ºæ™‚ï¼Œè™§ææ¸›å°‘ 10%ã€‚"},
    {id: 14, name: "ç¥ç¶“åˆ€", desc: "å¤±æ§æ©Ÿç‡å¢åŠ ï¼Œä½†å¤±æ§æ™‚å¯èƒ½è³ºå¤§éŒ¢ã€‚"},
    {id: 15, name: "ç¤¾äº¤é”äºº", desc: "é‡åˆ°å¥‡é‡çš„æ©Ÿç‡å¢åŠ  20%ã€‚"},
    {id: 16, name: "å¤±çœ ç—‡", desc: "æ¯å€‹æœˆéš¨æ©Ÿå¼·åˆ¶ä¼‘æ¯ä¸€å¤©ã€‚"},
    {id: 17, name: "ç²¾ç®—å¸«", desc: "å¯ä»¥çœ‹ç©¿éƒ¨åˆ†è™›å‡æ–°è (æç¤ºæ›´æº–ç¢º)ã€‚"},
    {id: 18, name: "ä½›ç³»", desc: "ä»€éº¼éƒ½ä¸åšæ™‚ï¼Œå¿«æ¨‚å€¼æ¢å¾©é›™å€ã€‚"},
    {id: 19, name: "æ§“æ¡¿ç‹‚é­”", desc: "åªèƒ½é¸æ“‡ 50% æˆ– 100% å€‰ä½ã€‚"},
    {id: 20, name: "æˆ‘çˆ¸æ˜¯Elon Musk", desc: "50%æ©Ÿç‡ç›´æ¥ç²å‹ï¼Œ50%æ©Ÿç‡ç ´ç”¢é–‹å±€ä½†é‹æ°£çˆ†æ£šã€‚", isEasterEgg: true}
];

// éŠæˆ²ç‹€æ…‹
let state = {
    day: 1,
    age: 18,
    money: 0,
    stress: 0,
    happy: 100,
    luck: 50,
    hasLoan: false,
    salary: 0,
    livingCost: LIVING_COST_BASE,
    traits: [],
    name: "",
    selectedPos: 0.2, // 20%
    nextTradeWin: false, // å¿…å‹flag
    currentStock: null
};

// å·¥å…·å‡½æ•¸
const rand = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
const formatMoney = (m) => "$" + Math.floor(m).toLocaleString();

/**
 * åˆå§‹åŒ–é‚è¼¯
 */
function initStartScreen() {
    // éš¨æ©Ÿé¸6å€‹ç‰¹æ€§ä¾›é¸æ“‡ (å¿…é ˆåŒ…å« Elon Musk å¦‚æœéš¨æ©Ÿåˆ°çš„è©±ï¼Œæˆ–è€…å¼·åˆ¶åŒ…å«æ–¹ä¾¿æ¸¬è©¦? ä¸ï¼ŒæŒ‰è¦æ±‚éš¨æ©Ÿ)
    let shuffled = [...TRAITS_POOL].sort(() => 0.5 - Math.random());
    let choices = shuffled.slice(0, 6);
    
    // æ¸²æŸ“ç‰¹æ€§
    const container = document.getElementById('trait-selection');
    container.innerHTML = '';
    choices.forEach(t => {
        let div = document.createElement('div');
        div.className = 'trait-card';
        div.innerHTML = `<strong>${t.name}</strong><br>${t.desc}`;
        div.onclick = () => toggleTrait(div, t);
        container.appendChild(div);
    });
}

let selectedTraits = [];

function toggleTrait(el, trait) {
    if (selectedTraits.includes(trait)) {
        selectedTraits = selectedTraits.filter(t => t !== trait);
        el.classList.remove('selected');
    } else {
        if (selectedTraits.length < 2) {
            selectedTraits.push(trait);
            el.classList.add('selected');
        }
    }
}

function confirmStart() {
    const name = document.getElementById('player-name').value;
    if (!name) return alert("è«‹è¼¸å…¥åå­—ï¼");
    if (selectedTraits.length !== 2) return alert("è«‹é¸æ“‡å…©å€‹ç‰¹æ€§ï¼");
    
    state.name = name;
    state.traits = selectedTraits;
    
    // å±¬æ€§åˆå§‹åŒ–åŸºæ–¼åå­— (ç°¡å–®å“ˆå¸Œ)
    let seed = 0;
    for(let i=0; i<name.length; i++) seed += name.charCodeAt(i);
    state.luck = 40 + (seed % 40); // 40-80 base luck
    
    // æ‡‰ç”¨ç‰¹æ€§åˆå§‹æ•ˆæœ
    applyTraitEffectsInit();
    
    document.getElementById('start-screen').classList.add('hidden');
    document.getElementById('career-choice').classList.remove('hidden');
}

function applyTraitEffectsInit() {
    state.traits.forEach(t => {
        if (t.id === 1) state.stressLocked = true; // çµ•å°ç†æ€§
        if (t.id === 2) state.happyLocked = true; // æ¨‚è§€ä¸»ç¾©
        if (t.id === 3) state.money += 100000; // å°åº·ä¹‹å®¶
        if (t.id === 4) state.livingCost = 1000; // å…¬å±‹
        if (t.id === 6) state.luck += 20; // ç»ç’ƒå¿ƒ
        if (t.id === 8) state.luck = 90; // å¤©é¸
        if (t.id === 9) state.luck = 10; // å€’éœ‰
        if (t.id === 10) state.nextTradeWin = true; // å…§å¹•
        if (t.id === 11) state.maxStress = 150;
        if (t.id === 12) state.livingCost *= 1.5; // æ®éœ
        
        // å½©è›‹æª¢æ¸¬
        if (t.isEasterEgg) {
            if (Math.random() < 0.5) {
                // çœŸ Elon
                alert("å½©è›‹è§¸ç™¼ï¼šä½ çˆ¸çœŸçš„æ˜¯ Elon Muskï¼");
                state.money = 100000000000;
                checkWinCondition();
            } else {
                // å‡ Elon
                alert("å½©è›‹è§¸ç™¼ï¼šä½ çˆ¸æ˜¯ã€Œä¼Šæ’ˆåª½ã€ï¼Œå…¶å¯¦æ˜¯é¨™å­ã€‚è³‡ç”¢ç¸®æ°´ï¼Œä½†ä½ é‹æ°£çˆ†æ£šï¼");
                state.money *= 0.2;
                state.luck += 200;
            }
        }
    });
}

function startGame(isLoan) {
    if (isLoan) {
        state.money += 200000;
        state.hasLoan = true;
    } else {
        state.money += 0;
        state.salary = 15000;
        // æ‰“å·¥è–é«”ç‰¹æ€§æª¢æŸ¥
        if (hasTrait(5)) state.isSaint = true;
    }
    
    document.getElementById('career-choice').classList.add('hidden');
    document.getElementById('game-container').classList.remove('hidden');
    
    log(`éŠæˆ²é–‹å§‹ã€‚${state.name} è¸å…¥äº†ç¤¾æœƒã€‚`);
    if (state.hasLoan) log(`èƒŒè² å­¸è²¸ $200,000ï¼Œæ¯æœˆéœ€é‚„ $5,000ã€‚`);
    else log(`é¸æ“‡æ‰“å·¥ï¼Œæœˆè–ª $15,000ã€‚`);
    
    updateUI();
    nextDay();
}

/**
 * æ ¸å¿ƒéŠæˆ²å¾ªç’°
 */
function nextDay() {
    state.day++;
    
    // æ¯30å¤©çµç®—
    if (state.day % 30 === 0) {
        monthProcess();
    }
    
    // æª¢æŸ¥è¼¸è´
    if (state.money < 0) return endGame("ç ´ç”¢äº†", "ä½ çš„è³‡é‡‘æ­¸é›¶ï¼Œæµè½è¡—é ­ã€‚");
    if (state.money >= GAME_GOAL) return endGame("è²¡å‹™è‡ªç”±", "ä½ é”æˆäº†ä¸€å€‹å„„çš„å°ç›®æ¨™ï¼");

    // ç”Ÿæˆä»Šæ—¥è‚¡ç¥¨
    generateDailyStock();
    
    // æ›´æ–°UI
    updateUI();
    
    // éš¨æ©Ÿå¥‡é‡æª¢æ¸¬ (åŸºç¤10% + ç‰¹æ€§åŠ æˆ)
    let encounterChance = 0.1;
    if (hasTrait(15)) encounterChance += 0.2;
    if (Math.random() < encounterChance) {
        triggerEncounter();
    }
}

function monthProcess() {
    let cost = state.livingCost;
    let income = state.salary;
    let loan = state.hasLoan ? LOAN_REPAY : 0;
    
    // æ‰“å·¥è–é«” æ¯å¹´(360å¤©)ç¿»å€
    if (state.isSaint && state.day % 360 === 0) {
        state.salary *= 2;
        log(`ã€æ‰“å·¥è–é«”ã€‘ç™¼å‹•ï¼å·¥è³‡ç¿»å€è‡³ ${formatMoney(state.salary)}ï¼`);
    }

    state.money -= cost;
    state.money -= loan;
    state.money += income;
    
    log(`ã€æœˆåº•çµç®—ã€‘ç”Ÿæ´»è²» -$${cost}, é‚„è²¸ -$${loan}, å·¥è³‡ +$${income}ã€‚çµé¤˜: ${formatMoney(state.money)}`);
}

function generateDailyStock() {
    const name = STOCK_PREFIXES[rand(0, STOCK_PREFIXES.length-1)] + STOCK_SUFFIXES[rand(0, STOCK_SUFFIXES.length-1)];
    
    // ç”Ÿæˆè¶¨å‹¢ -100 åˆ° 100
    const t5 = rand(-20, 20);
    const t30 = rand(-50, 50);
    const t365 = rand(-100, 200);
    
    // æ±ºå®šçœŸæ–°èé‚„æ˜¯å‡æ–°è
    let isGoodNews = Math.random() > 0.5;
    let newsText = isGoodNews ? NEWS_GOOD[rand(0, NEWS_GOOD.length-1)] : NEWS_BAD[rand(0, NEWS_BAD.length-1)];
    
    // å¯¦éš›æ¼²è·Œæ¦‚ç‡ (éš±è—å€¼)
    // åŸºç¤ 50/50ï¼Œå—æ–°èå½±éŸ¿
    let bullChance = 0.5;
    if (isGoodNews) bullChance += 0.2; else bullChance -= 0.2;
    
    // è¶¨å‹¢å½±éŸ¿
    if (t5 > 0) bullChance += 0.05;
    if (t30 > 0) bullChance += 0.05;
    
    // ç²¾ç®—å¸«ç‰¹æ€§ï¼šæç¤ºæ–°èçœŸå‡ (é€šéUIé¡è‰²æˆ–æ¨™è¨˜)
    if (hasTrait(17) && Math.random() < 0.7) {
        newsText = `[çœ‹ç©¿] ${newsText}`;
    }

    state.currentStock = {
        name: name,
        t5: t5,
        t30: t30,
        t365: t365,
        news: newsText,
        bullChance: bullChance,
        volatility: rand(5, 30) // æ³¢å‹•ç‡ 5% - 30%
    };
    
    // æ¸²æŸ“å¸‚å ´é¢æ¿
    document.getElementById('stock-name').innerText = name;
    document.getElementById('stock-news').innerText = newsText;
    document.getElementById('stock-news').className = isGoodNews ? "news-flash up" : "news-flash down";
    
    const fmtTrend = (v) => `<span class="${v>=0?'up':'down'}">${v>=0?'+':''}${v}%</span>`;
    document.getElementById('trend-5').innerHTML = fmtTrend(t5);
    document.getElementById('trend-30').innerHTML = fmtTrend(t30);
    document.getElementById('trend-365').innerHTML = fmtTrend(t365);
}

/**
 * äº¤æ˜“é‚è¼¯
 */
function setPos(percent) {
    if (hasTrait(19) && (percent === 0.05 || percent === 0.2)) {
        alert("ã€æ§“æ¡¿ç‹‚é­”ã€‘ä½ çš„æ‰‹ä¸è½ä½¿å–šï¼Œåªèƒ½ä¸‹å¤§æ³¨ï¼");
        return;
    }
    state.selectedPos = percent;
    document.querySelectorAll('.pos-btn').forEach(b => b.classList.remove('active'));
    event.target.classList.add('active');
}

function trade(type) {
    // æª¢æŸ¥å¤±æ§ç‹€æ…‹
    let isCrazy = false;
    if (!state.stressLocked && state.stress > 80) isCrazy = true;
    if (!state.happyLocked && state.happy < 20) isCrazy = true;
    
    if (isCrazy && Math.random() < 0.5) { // 50%æ©Ÿç‡å¤±æ§
        log("<span class='danger-text'>ã€å¿ƒæ…‹å´©äº†ã€‘ä½ é›™çœ¼ç™¼ç´…ï¼Œæ‰‹æ»‘äº‚é»äº†ä¸€é€šï¼</span>");
        // éš¨æ©Ÿæ“ä½œ
        type = Math.random() > 0.5 ? 'long' : 'short';
        state.selectedPos = [0.05, 0.2, 0.5, 1.0][rand(0,3)];
        
        // ç¥ç¶“åˆ€ç‰¹æ€§
        if (hasTrait(14)) {
            state.currentStock.volatility *= 2; // æ³¢å‹•ç¿»å€
            log("ã€ç¥ç¶“åˆ€ã€‘è§¸ç™¼ï¼é€™æ³¢æ“ä½œä¸æˆåŠŸä¾¿æˆä»ï¼");
        }
    } else if (type === 'skip') {
        log(`ä½ é¸æ“‡è§€æœ› ${state.currentStock.name}ã€‚`);
        // æ¢å¾©å¿«æ¨‚
        let rec = hasTrait(18) ? 10 : 5; // ä½›ç³»å›è¡€
        changeHappy(rec);
        changeStress(-5);
        nextDay();
        return;
    }

    // è¨ˆç®—æœ¬é‡‘
    let principal = state.money * state.selectedPos;
    if (principal < 100) principal = state.money; // All in if low
    
    let stock = state.currentStock;
    let actualMove = 0;
    
    // è¨ˆç®—çµæœ
    // å¿…å‹é‚è¼¯
    if (state.nextTradeWin) {
        actualMove = Math.abs(stock.volatility); // å¿…æ¼²/è·Œè‡³ç›ˆåˆ©æ–¹å‘
        if (type === 'short') actualMove = -actualMove; // å¦‚æœåšç©ºï¼Œè®“è‚¡ç¥¨è·Œ
        state.nextTradeWin = false;
        log("<span class='event-text'>ã€å…§å¹•æ¶ˆæ¯ã€‘ç”Ÿæ•ˆï¼é€™æ³¢ç©©äº†ï¼</span>");
    } else {
        // æ­£å¸¸éš¨æ©Ÿ
        let isUp = Math.random() < stock.bullChance;
        let percent = rand(1, stock.volatility);
        
        // é‹æ°£ä¿®æ­£
        if (state.luck > 80 && Math.random() < 0.3) isUp = (type === 'long'); // å¥½é‹ä¿®æ­£
        if (state.luck < 20 && Math.random() < 0.3) isUp = (type !== 'long'); // éœ‰é‹ä¿®æ­£

        actualMove = isUp ? percent : -percent;
    }
    
    // è¨ˆç®—ç›ˆè™§
    let pnlPercent = 0;
    if (type === 'long') pnlPercent = actualMove;
    else pnlPercent = -actualMove;
    
    // æ…é‡å‹‡è€…è™§ææ¸›å…
    if (pnlPercent < 0 && hasTrait(13)) {
        pnlPercent *= 0.9;
    }
    
    let pnl = principal * (pnlPercent / 100);
    state.money += pnl;
    
    // æ›´æ–°å¿ƒæ…‹
    if (pnl > 0) {
        changeStress(-10);
        changeHappy(5);
        log(`åš${type==='long'?'å¤š':'ç©º'} ${stock.name} ${state.selectedPos*100}%å€‰ä½ã€‚ <span class="up">ç›ˆåˆ© ${formatMoney(pnl)} (+${Math.abs(actualMove)}%)</span>`);
    } else {
        // è™§éŒ¢å£“åŠ›å¤§
        let stressAdd = 10;
        if (hasTrait(6)) stressAdd *= 2; // ç»ç’ƒå¿ƒ
        changeStress(stressAdd);
        changeHappy(-10);
        log(`åš${type==='long'?'å¤š':'ç©º'} ${stock.name} ${state.selectedPos*100}%å€‰ä½ã€‚ <span class="down">è™§æ ${formatMoney(Math.abs(pnl))} (-${Math.abs(actualMove)}%)</span>`);
    }
    
    nextDay();
}

/**
 * å¥‡é‡ç³»çµ±
 */
const ENCOUNTERS = [
    {
        title: "ç¥ç¥•ä¹ä¸",
        desc: "è·¯é‚Šä¸€å€‹ä¹ä¸æ””ä½ä½ ï¼Œå…œå”®ä¸€æœ¬ç ´æ›¸ã€ŠKç·šçœŸç¶“ã€‹ã€‚",
        choices: [
            { txt: "èŠ±$1000è²·äº†", effect: () => { 
                if(state.money < 1000) return "æ²’éŒ¢"; 
                state.money -= 1000; 
                if(checkLuck()) { state.luck += 10; return "æ›¸è£¡å¤¾è‘—ä¸€å¼µå½©ç¥¨ï¼Œä¸­äº†å°çï¼Œé‹æ°£æå‡ï¼"; }
                else { state.stress += 10; return "å…¨æ˜¯å»¢ç´™ï¼Œè¢«é¨™äº†ã€‚"; }
            }},
            { txt: "çµ¦ä»–$100åƒé£¯", effect: () => {
                state.money -= 100; state.happy += 5; state.luck += 5; return "å¥½äººæœ‰å¥½å ±ï¼Œå¿ƒæƒ…è®Šå¥½äº†ã€‚";
            }},
            { txt: "ç„¡è¦–", effect: () => "ä½ å†·æ¼ åœ°èµ°é–‹äº†ã€‚"},
            { txt: "è¸¢ç¿»ä»–çš„ç¢—", effect: () => { state.luck -= 20; state.stress -= 5; return "ç™¼æ´©äº†æƒ…ç·’ï¼Œä½†æ„Ÿè¦ºé‹æ°£è®Šå·®äº†ã€‚"; }}
        ]
    },
    {
        title: "è€åŒå­¸èšæœƒ",
        desc: "é«˜ä¸­åŒå­¸é‚€è«‹ä½ åƒåŠ èšæœƒï¼Œæ“šèªªæœ‰äººæ··å¾—å¾ˆå¥½ã€‚",
        choices: [
            { txt: "åƒåŠ  (èŠ±è²»$2000)", effect: () => {
                if(state.money < 2000) return "æ²’éŒ¢å»";
                state.money -= 2000;
                if(Math.random() < 0.3) { state.nextTradeWin = true; return "è½åˆ°äº†å…§å¹•æ¶ˆæ¯ï¼ä¸‹æ¬¡äº¤æ˜“å¿…å‹ï¼"; }
                else { state.stress += 10; return "å…¨æ˜¯ç‚«å¯Œçš„ï¼Œè½å¾—å¿ƒç…©ã€‚"; }
            }},
            { txt: "ä¸å»", effect: () => { state.happy += 5; return "åœ¨å®¶æ‰“éŠæˆ²æ›´å¿«æ¨‚ã€‚"; }},
            { txt: "å€ŸéŒ¢çµ¦åŒå­¸", effect: () => {
                let amt = state.money * 0.1; state.money -= amt;
                if(checkLuck()) { setTimeout(()=>{state.money += amt*3; log("åŒå­¸é‚„éŒ¢äº†ï¼ä¸‰å€å¥‰é‚„ï¼")}, 5000); return "åŒå­¸æ‹¿éŒ¢å»å‰µæ¥­äº†..."; }
                else return "è‚‰åŒ…å­æ‰“ç‹—ï¼Œæœ‰å»ç„¡å›ã€‚";
            }},
            { txt: "ç‚«è€€è‡ªå·±", effect: () => { state.happy += 20; state.luck -= 5; return "é›–ç„¶çˆ½äº†ï¼Œä½†å¥½åƒå¾—ç½ªäº†äººã€‚"; }}
        ]
    },
    {
        title: "æŠ•è³‡è¬›åº§",
        desc: "æ‰€è¬‚çš„ã€Œå¤§å¸«ã€æ­£åœ¨èˆ‰è¾¦å…è²»è¬›åº§ã€‚",
        choices: [
            { txt: "èªçœŸè½è¬›", effect: () => { state.stress += 5; return "å­¸åˆ°äº†ä¸€äº›æŠ€è¡“åˆ†æçš®æ¯›ã€‚"; }},
            { txt: "è³ªç–‘å¤§å¸«", effect: () => { 
                if(state.luck > 60) { state.money += 5000; return "ä½ æ­ç©¿äº†å¤§å¸«ï¼Œä¸»è¾¦æ–¹é€€çµ¦ä½ å°å£è²»ã€‚"; }
                else { state.happy -= 10; return "è¢«ä¿å…¨è¶•äº†å‡ºä¾†ã€‚"; }
            }},
            { txt: "è³¼è²·èª²ç¨‹ ($5000)", effect: () => {
                if(state.money < 5000) return "è²·ä¸èµ·";
                state.money -= 5000;
                state.nextTradeWin = true; return "é›–ç„¶è²´ï¼Œä½†ç¢ºå¯¦çµ¦äº†ä¸€å€‹æº–ç¢ºçš„ä»£ç¢¼ã€‚";
            }},
            { txt: "ç¡è¦º", effect: () => { state.stress -= 20; return "å†·æ°£å¾ˆè¶³ï¼Œç¡å¾—å¾ˆé¦™ã€‚"; }}
        ]
    }
    // å¯ä»¥æ“´å±•æ›´å¤šå¥‡é‡...
];

function checkLuck() {
    return Math.random() * 100 < state.luck;
}

function triggerEncounter() {
    // éš¨æ©Ÿé¸ä¸€å€‹äº‹ä»¶
    let evt = ENCOUNTERS[rand(0, ENCOUNTERS.length - 1)];
    
    document.getElementById('event-title').innerText = evt.title;
    document.getElementById('event-desc').innerText = evt.desc;
    
    let btnContainer = document.getElementById('event-choices');
    btnContainer.innerHTML = '';
    
    evt.choices.forEach(c => {
        let btn = document.createElement('button');
        btn.className = 'choice-btn';
        btn.innerText = c.txt;
        btn.onclick = () => {
            let res = c.effect();
            log(`<span class="event-text">ã€å¥‡é‡çµæœã€‘${res}</span>`);
            document.getElementById('event-screen').classList.add('hidden');
        };
        btnContainer.appendChild(btn);
    });
    
    document.getElementById('event-screen').classList.remove('hidden');
}

/**
 * è¼”åŠ©é‚è¼¯
 */
function updateUI() {
    document.getElementById('val-money').innerText = formatMoney(state.money);
    document.getElementById('val-date').innerText = `ç¬¬ ${state.day} å¤©`;
    
    document.getElementById('val-stress').innerText = state.stress;
    document.getElementById('bar-stress').style.width = Math.min(state.stress, 100) + '%';
    
    document.getElementById('val-happy').innerText = state.happy;
    document.getElementById('bar-happy').style.width = state.happy + '%';
    
    document.getElementById('val-luck').innerText = state.luck;
    
    let statusText = "æ­£å¸¸";
    if (state.stress > 80) statusText = "å´©æ½°é‚Šç·£";
    if (state.happy < 20) statusText = "æŠ‘é¬±";
    document.getElementById('val-status').innerText = statusText;
    if (statusText !== "æ­£å¸¸") document.getElementById('val-status').className = "blink danger-text";
    else document.getElementById('val-status').className = "";
}

function hasTrait(id) {
    return state.traits.some(t => t.id === id);
}

function changeStress(val) {
    if (state.stressLocked) return;
    state.stress += val;
    let max = state.maxStress || 100;
    if (state.stress < 0) state.stress = 0;
    if (state.stress > max) state.stress = max;
}

function changeHappy(val) {
    if (state.happyLocked) return;
    state.happy += val;
    if (state.happy < 0) state.happy = 0;
    if (state.happy > 100) state.happy = 100;
}

function log(msg) {
    const logArea = document.getElementById('log-area');
    const div = document.createElement('div');
    div.className = 'log-entry';
    div.innerHTML = `<span class="log-date">Day ${state.day}</span> ${msg}`;
    logArea.appendChild(div);
    logArea.scrollTop = logArea.scrollHeight;
}

function endGame(title, reason) {
    document.getElementById('end-screen').classList.remove('hidden');
    document.getElementById('end-title').innerText = title;
    document.getElementById('end-reason').innerText = reason;
    document.getElementById('end-money').innerText = formatMoney(state.money);
}

function checkWinCondition() {
     if (state.money >= GAME_GOAL) return endGame("è²¡å‹™è‡ªç”±", "ä½ é”æˆäº†ä¸€å€‹å„„çš„å°ç›®æ¨™ï¼");
}

// å•Ÿå‹•åˆå§‹åŒ–
initStartScreen();

</script>
</body>
</html>